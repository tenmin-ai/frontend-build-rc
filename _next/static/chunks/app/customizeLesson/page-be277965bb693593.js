(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3175],{1814:function(e,t,r){Promise.resolve().then(r.bind(r,1130))},1130:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return u}});var n=r(7437),i=r(2265),o=r(8079),s=r(9376),a=r(1273),l=r(8706),c=r(6870);function u(){let e=(0,s.useSearchParams)(),t=(0,s.useRouter)(),r=(0,c.Y)(),[u,d]=(0,i.useState)([]),f=async()=>{d((await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind));let e=u.find(e=>e.label.includes("AirPods"));e&&m(e.deviceId)};(0,i.useEffect)(()=>{if(void 0===navigator.mediaDevices){console.log("navigator.mediaDevices is undefined");return}f(),navigator.mediaDevices.ondevicechange=f},[]),(0,i.useEffect)(()=>{let e=setInterval(()=>{f()},1e3);return()=>clearInterval(e)},[]);let{selectedMic:h,acquireMic:m,isVoiceDetected:p}=(0,l.Z)({recordingChunkSize:100}),[b,v]=(0,i.useState)(!1),[x,g]=(0,i.useState)("Beginner"),[y,w]=(0,i.useState)(!1),j=(e,n,i)=>{w(!0),(0,o.oY)({path:{service:"ws"},query:{tutoring_id:e,lesson_id:n,mode:i}}).then(e=>{e.data&&(r.resume(),t.push("/call?session_id=".concat(e.data.session_id)))}).catch(e=>{console.error(e)})};return(0,n.jsxs)("main",{className:"h-screen-safe flex flex-col justify-between bg-[#FAFBFF] pt-5 tracking-[-0.02em]",children:[(0,n.jsx)("div",{className:"flex w-full flex-col items-center px-7 pb-6",children:(0,n.jsxs)("div",{className:"flex w-full items-center justify-between px-1",children:[(0,n.jsx)("button",{className:"flex h-12 items-center justify-center self-start rounded-full text-black",onClick:()=>{t.push("/")},children:(0,n.jsx)(a._0w,{className:"text-xl"})}),(0,n.jsx)("button",{className:"flex h-12 items-center justify-center self-start rounded-full text-black/30",onClick:()=>{},children:(0,n.jsx)(a.kvo,{className:"text-xl"})})]})}),(0,n.jsx)("div",{className:"overflow-y-auto",children:e.get("tutoring_id")&&e.get("lesson_id")?(0,n.jsxs)("div",{className:"flex flex-col gap-5 px-7",children:[(0,n.jsx)("div",{className:"flex h-full w-full flex-col items-center justify-center gap-4 pb-12",children:[{name:"Beginner",value:"Beginner",description:"We give you all the cheats!",emoji:"\uD83D\uDC66\uD83C\uDFFB",activated:!0},{name:"Intermediate",value:"Intermediate",description:"Can you deal without translations?",emoji:"\uD83C\uDFEB",activated:!0},{name:"Advanced",value:"Advanced",description:"No more training wheels!",emoji:"\uD83D\uDC69\uD83C\uDFFB‍\uD83C\uDF93",activated:!0},{name:"Native (Experimental)",value:"Realtime",description:"Real time conversation like a native!",emoji:"\uD83E\uDDD0",activated:!0}].map(e=>(0,n.jsxs)("button",{className:"flex w-full items-center gap-3 rounded-lg border-[1px] px-7 py-4 text-base ".concat(x===e.value?"border-[#0039FF] bg-[#0039FF]/5 text-[#0039FF]":"border-black/10 bg-white"," ").concat(!e.activated&&"opacity-50"),onClick:()=>{e.activated&&g(e.value)},children:[(0,n.jsx)("p",{className:"mr-3 text-2xl",children:e.emoji}),(0,n.jsxs)("div",{className:"text-left",children:[(0,n.jsx)("p",{className:"font-medium",children:e.name}),(0,n.jsx)("p",{className:"text-sm font-light text-black/50",children:e.description})]})]},e.value))}),(0,n.jsxs)("button",{className:"text-center font-light text-black/30 underline",onClick:()=>{v(!b)},children:[b?"Hide":"Show"," audio device options"]}),b&&(0,n.jsxs)("div",{className:"flex flex-col gap-5",children:[(0,n.jsx)("div",{className:"flex flex-col gap-2",children:u.map(e=>(0,n.jsx)("button",{className:"flex w-full items-center justify-between rounded-lg border px-3 py-3 font-normal ".concat(h==e.deviceId?"border-[#0039FF] bg-[#0039FF]/5 text-[#0039FF]":"bg-white"),onClick:()=>{m(e.deviceId)},children:(0,n.jsx)("p",{className:"text-sm",children:e.label||"Unknown Microphone"})},e.deviceId))}),(0,n.jsxs)("div",{className:"mb-12 flex items-center gap-2 text-sm text-black/30",children:[(0,n.jsx)("p",{children:"Try speaking to test your microphone:"}),(0,n.jsx)("div",{className:"flex h-1 w-8 items-center justify-center rounded-full ".concat(p?"bg-green-500":"bg-black/10")})]})]})]}):(0,n.jsxs)("div",{className:"flex flex-col gap-5",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-black",children:"No Lesson Found"}),(0,n.jsx)("p",{className:"text-gray-500",children:"No lesson found to start."})]})}),(0,n.jsx)("div",{className:"pointer-events-none w-full justify-end gap-5 tracking-[-0.02em]",children:(0,n.jsx)("div",{className:"pointer-events-auto flex w-full flex-col gap-4 border-t-2 border-black/10 bg-white pb-10 pt-6",children:(0,n.jsx)("button",{className:"mx-8 flex h-[3.6rem] flex-grow items-center justify-center rounded-full bg-[#0039FF] px-4 font-bold text-white",onClick:()=>{j(e.get("tutoring_id"),e.get("lesson_id"),x)},children:y?(0,n.jsx)(a.fCD,{className:"animate-spin"}):(0,n.jsx)("p",{className:"text-lg font-medium",children:"Start"})})})})]})}},6870:function(e,t,r){"use strict";r.d(t,{GlobalAudioContextProvider:function(){return s},Y:function(){return a}});var n=r(7437),i=r(2265);let o=(0,i.createContext)(null),s=e=>{let{children:t}=e,r=(0,i.useRef)(null);return r.current||(console.log("creating audio context"),r.current=new AudioContext,r.current.onstatechange=()=>{var e,t,n,i,o;if(console.log("onstagechange - AudioContext state changed: ",null===(e=r.current)||void 0===e?void 0:e.state),(null===(t=r.current)||void 0===t?void 0:t.state)==="suspended"&&(null===(i=r.current)||void 0===i||i.resume().then(()=>{var e;console.log("AudioContext state: ",null===(e=r.current)||void 0===e?void 0:e.state)}).catch(e=>{console.error("Failed to resume AudioContext:",e)})),(null===(n=r.current)||void 0===n?void 0:n.state)==="running"){let e=null===(o=r.current)||void 0===o?void 0:o.currentTime;setTimeout(()=>{var t;(null===(t=r.current)||void 0===t?void 0:t.currentTime)===e&&(console.warn("AudioContext currentTime is stuck, attempting to fix..."),window.location.reload())},100)}}),(0,n.jsx)(o.Provider,{value:r.current,children:t})},a=()=>{let e=(0,i.useContext)(o);if(!e)throw Error("useAudioContext must be used within a GlobalAudioContextProvider");return e}},8706:function(e,t,r){"use strict";r.d(t,{Z:function(){return l}});var n=r(2265),i=r(9800),o=r(3974);class s{register(e){let t=Symbol("subscriber");return console.log("Registering subscriber:",t.toString()),this.subscribers.set(t,{init:e,initializing:this.initializeSubscriber(e)}),()=>this.removeSubscriber(t)}async resume(){if(this.audioContext&&"suspended"===this.audioContext.state)try{await this.audioContext.resume(),console.log("AudioContext resumed. State:",this.audioContext.state)}catch(e){console.error("Failed to resume AudioContext:",e)}}async ensureAudioContext(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];if(this.audioContext&&"closed"!==this.audioContext.state)return this.audioContext;for(let e of(this.audioContext&&(console.warn("AudioContext is closed, cleaning up and recreating..."),this.cleanupAllSubscribers()),console.log("Creating a new AudioContext"),this.audioContext=new AudioContext(this.audioContextOptions),this.audioWorkletModules))await this.audioContext.audioWorklet.addModule(e);return e&&this.initializeAllSubscribers(),this.audioContext.onstatechange=this.handleAudioContextStateChange,this.audioContext}async handleAudioContextStateChange(){if(this.audioContext){if(console.log("AudioContext state changed:",this.audioContext.state),"running"===this.audioContext.state){let e=this.audioContext.currentTime;setTimeout(async()=>{this.audioContext&&this.audioContext.currentTime===e&&(console.warn("AudioContext currentTime is stuck, recreating..."),await this.ensureAudioContext(),alert("iOS AudioContext stuck bug!!!"))},100)}"closed"===this.audioContext.state&&(console.warn("AudioContext closed, recreating..."),await this.ensureAudioContext())}}async initializeSubscriber(e){console.log("Initializing subscriber...");let t=await this.ensureAudioContext(!1),r=await e(t);return console.log("Subscriber initialized."),r}async removeSubscriber(e){console.log("Removing subscriber:",e.toString());let t=this.subscribers.get(e);if(!t)throw Error("Removing a non-existent subscriber:"+e.toString());(await t.initializing)(),this.subscribers.delete(e),console.log("Subscriber removed:",e.toString())}initializeAllSubscribers(){for(let[,e]of this.subscribers.entries())e.initializing=this.initializeSubscriber(e.init)}cleanupAllSubscribers(){for(let[,e]of this.subscribers.entries())e.initializing.then(e=>e())}constructor(e,t){if(this.audioContext=null,this.audioContextOptions={},this.subscribers=new Map,this.audioWorkletModules=new Set,e&&(this.audioContextOptions=e),t)for(let e of t)this.audioWorkletModules.add(e)}}let a=new s({sampleRate:16e3},["worklets/pcm-recorder.js"]);function l(e){let{onSpeechStart:t,onSpeechEnd:r,onAudioData:s,onPCMData:l,onRecordingStart:c,onRecordingStop:u,micVolume:d=1,recordingChunkSize:f}=e,h=(0,n.useRef)(null),m=(0,n.useRef)(null),p=(0,n.useRef)(null),b=(0,n.useRef)(null),[v,x]=(0,n.useState)(!0),[g,y]=(0,n.useState)(!1),w=(0,n.useRef)(!1),[j,C]=(0,o.useLocalStorage)("selectedMic",null),[S,O]=(0,n.useState)(!1),N=(0,n.useRef)(t),A=(0,n.useRef)(r),k=(0,n.useRef)(l);(0,n.useEffect)(()=>{N.current=t},[t]),(0,n.useEffect)(()=>{A.current=r},[r]),(0,n.useEffect)(()=>{k.current=l},[l]),(0,n.useEffect)(()=>{g?P():T()},[g]),(0,n.useEffect)(()=>{if(!v)return;a.resume();let e=async e=>{try{let t=await navigator.mediaDevices.getUserMedia({audio:{deviceId:null!=j?j:void 0,echoCancellation:!0,sampleRate:16e3}});console.log("Mic acquired",j);let n=e.createGain();e.createMediaStreamSource(t).connect(n),h.current=n,n.gain.value=d,await e.audioWorklet.addModule("/worklets/pcm-recorder.js");let o=new AudioWorkletNode(e,"pcm-recorder");n.connect(o),o.port.onmessage=e=>{var t;let r=e.data;null===(t=k.current)||void 0===t||t.call(k,r)},o.onprocessorerror=e=>{console.error("PCM Processor Error:",e)},b.current=o;let s=e.createMediaStreamDestination();o.connect(s);let a=new MediaRecorder(s.stream);m.current=a;let l=await i.MicVAD.new({workletURL:"/vad/vad.worklet.bundle.min.js",modelURL:"/vad/silero_vad.onnx",ortConfig:e=>{e.env.wasm.wasmPaths="/vad/"},stream:t,onSpeechStart:()=>{var e;O(!0),null===(e=N.current)||void 0===e||e.call(N)},onVADMisfire:()=>{var e;O(!1),null===(e=A.current)||void 0===e||e.call(A,!0)},onSpeechEnd:()=>{var e;O(!1),null===(e=A.current)||void 0===e||e.call(A,!1)},positiveSpeechThreshold:.5,negativeSpeechThreshold:.35});return l.start(),p.current=l,()=>{t.getTracks().forEach(e=>{e.stop(),t.removeTrack(e)}),console.log("Mic released"),o.port.close(),o.disconnect(),b.current===o&&(b.current=null),n.disconnect(),h.current===n&&(h.current=null),S&&(O(!1),null==r||r(!1)),l.destroy(),p.current===l&&(p.current=null),console.log("VAD destroyed")}}catch(e){if(e instanceof DOMException&&"NotAllowedError"===e.name)return console.log("User denied microphone access"),alert("Please allow microphone access to use this feature."),()=>{};return console.error("Error accessing microphone:",e),alert("Error accessing microphone: "+e),()=>{}}};return a.register(e)},[v,j]);let E=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;a.resume(),e&&C(e),x(!0)},D=(0,n.useRef)(void 0),R=e=>{let t=async()=>{null==s||s(await e.data.arrayBuffer()),D.current=void 0};D.current=t()},P=async()=>{var e;a.resume(),null===(e=b.current)||void 0===e||e.port.start(),m.current&&(m.current.ondataavailable=R,m.current.onstart=()=>{null==c||c()},m.current.onstop=async()=>{D.current&&await D.current,null==u||u(w.current)},w.current=!1,await m.current.start(f))},T=()=>{m.current&&m.current.stop()};return m.current&&(m.current.ondataavailable=R),h.current&&(h.current.gain.value=d),{isRecording:g,setRecording:y,cancelRecording:()=>{w.current=!0,y(!1)},acquireMic:E,releaseMic:()=>{T(),x(!1)},selectedMic:j,isVoiceDetected:S}}},5478:function(e,t,r){"use strict";r.d(t,{RL:function(){return m},_g:function(){return v},eI:function(){return x}});let n=/\{[^{}]+\}/g,i=({allowReserved:e,name:t,value:r})=>{if(null==r)return"";if("object"==typeof r)throw Error("Deeply-nested arrays/objects aren’t supported. Provide your own `querySerializer()` to handle these.");return`${t}=${e?r:encodeURIComponent(r)}`},o=({allowReserved:e,explode:t,name:r,style:n,value:o})=>{if(!t){let t=(e?o:o.map(e=>encodeURIComponent(e))).join((e=>{switch(e){case"form":default:return",";case"pipeDelimited":return"|";case"spaceDelimited":return"%20"}})(n));switch(n){case"label":return`.${t}`;case"matrix":return`;${r}=${t}`;case"simple":return t;default:return`${r}=${t}`}}let s=(e=>{switch(e){case"label":return".";case"matrix":return";";case"simple":return",";default:return"&"}})(n),a=o.map(t=>"label"===n||"simple"===n?e?t:encodeURIComponent(t):i({allowReserved:e,name:r,value:t})).join(s);return"label"===n||"matrix"===n?s+a:a},s=({allowReserved:e,explode:t,name:r,style:n,value:o})=>{if(o instanceof Date)return`${r}=${o.toISOString()}`;if("deepObject"!==n&&!t){let t=[];Object.entries(o).forEach(([r,n])=>{t=[...t,r,e?n:encodeURIComponent(n)]});let i=t.join(",");switch(n){case"form":return`${r}=${i}`;case"label":return`.${i}`;case"matrix":return`;${r}=${i}`;default:return i}}let s=(e=>{switch(e){case"label":return".";case"matrix":return";";case"simple":return",";default:return"&"}})(n),a=Object.entries(o).map(([t,o])=>i({allowReserved:e,name:"deepObject"===n?`${r}[${t}]`:t,value:o})).join(s);return"label"===n||"matrix"===n?s+a:a},a=({allowReserved:e,array:t,object:r}={})=>n=>{let a=[];if(n&&"object"==typeof n)for(let l in n){let c=n[l];null!=c&&(a=Array.isArray(c)?[...a,o({allowReserved:e,explode:!0,name:l,style:"form",value:c,...t})]:"object"!=typeof c?[...a,i({allowReserved:e,name:l,value:c})]:[...a,s({allowReserved:e,explode:!0,name:l,style:"deepObject",value:c,...r})])}return a.join("&")},l=({baseUrl:e,path:t,query:r,querySerializer:a,url:l})=>{let c=e+(l.startsWith("/")?l:`/${l}`);t&&(c=(({path:e,url:t})=>{let r=t,a=t.match(n);if(a)for(let t of a){let n=!1,a=t.substring(1,t.length-1),l="simple";a.endsWith("*")&&(n=!0,a=a.substring(0,a.length-1)),a.startsWith(".")?(a=a.substring(1),l="label"):a.startsWith(";")&&(a=a.substring(1),l="matrix");let c=e[a];null!=c&&(r=Array.isArray(c)?r.replace(t,o({explode:n,name:a,style:l,value:c})):"object"!=typeof c?"matrix"!==l?r.replace(t,"label"===l?`.${c}`:c):r.replace(t,`;${i({name:a,value:c})}`):r.replace(t,s({explode:n,name:a,style:l,value:c})))}return r})({path:t,url:c}));let u=r?a(r):"";return u.startsWith("?")&&(u=u.substring(1)),u&&(c+=`?${u}`),c},c=(e,t)=>{let r={...e,...t};return r.baseUrl?.endsWith("/")&&(r.baseUrl=r.baseUrl.substring(0,r.baseUrl.length-1)),r.headers=u(e.headers,t.headers),r},u=(...e)=>{let t=new Headers;for(let r of e)if(r&&"object"==typeof r)for(let[e,n]of r instanceof Headers?r.entries():Object.entries(r))if(null===n)t.delete(e);else if(Array.isArray(n))for(let r of n)t.append(e,r);else void 0!==n&&t.set(e,"object"==typeof n?JSON.stringify(n):n);return t};class d{_fns;constructor(){this._fns=[]}eject(e){let t=this._fns.indexOf(e);-1!==t&&(this._fns=[...this._fns.slice(0,t),...this._fns.slice(t+1)])}use(e){this._fns=[...this._fns,e]}}let f={bodySerializer:e=>JSON.stringify(e)},h=(e,t,r)=>{"string"==typeof r?e.append(t,r):e.append(t,JSON.stringify(r))},m={bodySerializer:e=>{let t=new URLSearchParams;return Object.entries(e).forEach(([e,r])=>{null!=r&&(Array.isArray(r)?r.forEach(r=>h(t,e,r)):h(t,e,r))}),t}},p=a({allowReserved:!1,array:{explode:!0,style:"form"},object:{explode:!0,style:"deepObject"}}),b={"Content-Type":"application/json"},v=(e={})=>({...f,baseUrl:"",fetch:globalThis.fetch,headers:b,parseAs:"auto",querySerializer:p,...e}),x=(e={})=>{let t=c(v(),e),r=()=>({...t}),n={request:new d,response:new d},i=async e=>{let r={...t,...e,headers:u(t.headers,e.headers)};r.body&&r.bodySerializer&&(r.body=r.bodySerializer(r.body)),r.body||r.headers.delete("Content-Type");let i=new Request(l({baseUrl:r.baseUrl??"",path:r.path,query:r.query,querySerializer:"function"==typeof r.querySerializer?r.querySerializer:a(r.querySerializer),url:r.url}),{redirect:"follow",...r});for(let e of n.request._fns)i=await e(i,r);let o=r.fetch,s=await o(i);for(let e of n.response._fns)s=await e(s,i,r);let c={request:i,response:s};if(s.ok){if(204===s.status||"0"===s.headers.get("Content-Length"))return{data:{},...c};if("stream"===r.parseAs)return{data:s.body,...c};let e=("auto"===r.parseAs?(e=>{if(e)return e.startsWith("application/json")||e.endsWith("+json")?"json":"multipart/form-data"===e?"formData":["application/","audio/","image/","video/"].some(t=>e.startsWith(t))?"blob":e.startsWith("text/")?"text":void 0})(s.headers.get("Content-Type")):r.parseAs)??"json",t=await s[e]();return"json"===e&&r.responseTransformer&&(t=await r.responseTransformer(t)),{data:t,...c}}let d=await s.text();if(r.throwOnError)throw Error(d);try{d=JSON.parse(d)}catch{}return{error:d||{},...c}};return{connect:e=>i({...e,method:"CONNECT"}),delete:e=>i({...e,method:"DELETE"}),get:e=>i({...e,method:"GET"}),getConfig:r,head:e=>i({...e,method:"HEAD"}),interceptors:n,options:e=>i({...e,method:"OPTIONS"}),patch:e=>i({...e,method:"PATCH"}),post:e=>i({...e,method:"POST"}),put:e=>i({...e,method:"PUT"}),request:i,setConfig:e=>(t=c(t,e),r()),trace:e=>i({...e,method:"TRACE"})}}},6231:function(e,t,r){"use strict";r.d(t,{w_:function(){return u}});var n=r(2265),i={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},o=n.createContext&&n.createContext(i),s=["attr","size","title"];function a(){return(a=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach(function(t){var n,i;n=t,i=r[t],(n=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(n))in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function u(e){return t=>n.createElement(d,a({attr:c({},e.attr)},t),function e(t){return t&&t.map((t,r)=>n.createElement(t.tag,c({key:r},t.attr),e(t.child)))}(e.child))}function d(e){var t=t=>{var r,{attr:i,size:o,title:l}=e,u=function(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r={};for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],!(t.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}(e,s),d=o||t.size||"1em";return t.className&&(r=t.className),e.className&&(r=(r?r+" ":"")+e.className),n.createElement("svg",a({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},t.attr,i,u,{className:r,style:c(c({color:e.color||t.color},t.style),e.style),height:d,width:d,xmlns:"http://www.w3.org/2000/svg"}),l&&n.createElement("title",null,l),e.children)};return void 0!==o?n.createElement(o.Consumer,null,e=>t(e)):t(i)}}},function(e){e.O(0,[7240,4753,254,5563,8079,2971,2117,1744],function(){return e(e.s=1814)}),_N_E=e.O()}]);