(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2293],{3658:function(e,t,s){Promise.resolve().then(s.bind(s,2842))},2842:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return P}});var n=s(7437),a=s(2265),l=s(4272),i=s(3974),o=s(3772),r=s(9376),c=s(9403);function d(e){let{children:t}=e,s=(0,i.useIsClient)(),{token:a}=(0,c.f)(),d=(0,r.useSearchParams)().get("session_id");return d?s?(0,n.jsx)(l.eA,{url:"".concat("wss://backend-us-rc.tenmin.ai","/ws/lesson/").concat(d,"?token=").concat(a),label:"Call",toast:o.A,autoconnect:!0,wsAuth:!0,binaryType:"arraybuffer",children:t}):null:(0,n.jsx)("div",{children:"Invalid lesson"})}var u=s(5095),m=s(755),x=s(9764);s(7354),s(6889);var h=s(3377),p=s(8706),f=s(3399),g=s(5123),v=s(1755),j=s(434),y=s(386),w=s(5040),b=s(1273),N=s(2859),S=s(3069);let A=e=>{let{isOpen:t,onClose:s}=e,[l,i]=(0,a.useState)([]),o=async()=>{i((await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind));let e=l.find(e=>e.label.includes("AirPods"));e&&c(e.deviceId)};(0,a.useEffect)(()=>{o(),navigator.mediaDevices&&void 0!==navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=o)},[]),(0,a.useEffect)(()=>{let e=setInterval(()=>{o()},1e3);return()=>clearInterval(e)},[]);let{selectedMic:r,acquireMic:c,isVoiceDetected:d}=(0,p.Z)({recordingChunkSize:100});return(0,n.jsxs)(S.y,{isOpen:t,onClose:s,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,n.jsx)(S.y.Container,{style:{backgroundColor:"#FAFBFF"},children:(0,n.jsx)(S.y.Content,{children:(0,n.jsxs)("div",{className:"w-full p-8 pb-16 text-black",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("p",{className:"text-lg font-semibold",children:"Settings"}),(0,n.jsx)("div",{className:"flex gap-3",children:(0,n.jsx)("button",{onClick:s,children:(0,n.jsx)(b._0w,{})})})]}),(0,n.jsxs)("div",{className:"mt-6 flex flex-col gap-5",children:[(0,n.jsx)("div",{className:"flex items-center gap-2 text-black",children:(0,n.jsx)("p",{children:"Your Microphone"})}),(0,n.jsx)("div",{className:"flex flex-col gap-2",children:l.map(e=>(0,n.jsx)("button",{className:"flex w-full items-center justify-between rounded-lg border px-3 py-3 font-normal ".concat(r==e.deviceId?"border-[#0039FF] bg-[#0039FF]/5 text-[#0039FF]":"bg-white"),onClick:()=>{c(e.deviceId)},children:(0,n.jsx)("p",{className:"text-sm",children:e.label||"Unknown Microphone"})},e.deviceId))}),(0,n.jsxs)("div",{className:"mb-12 flex items-center gap-2 text-sm text-black/30",children:[(0,n.jsx)("p",{children:"Try speaking to test your microphone:"}),(0,n.jsx)("div",{className:"flex h-1 w-8 items-center justify-center rounded-full ".concat(d?"bg-green-500":"bg-black/10")})]})]})]})})}),(0,n.jsx)(S.y.Backdrop,{onTap:s})]})};var T=s(4502);let E=e=>{let{isOpen:t,onClose:s}=e;return(0,n.jsxs)(S.y,{isOpen:t,onClose:s,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,n.jsx)(S.y.Container,{style:{backgroundColor:"#FAFBFF"},children:(0,n.jsx)(S.y.Content,{children:(0,n.jsxs)("div",{className:"w-full p-8 pb-16 text-black",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("p",{className:"text-lg font-semibold",children:"Tips and tricks"}),(0,n.jsx)("div",{className:"flex gap-3",children:(0,n.jsx)("button",{onClick:s,children:(0,n.jsx)(b._0w,{})})})]}),(0,n.jsx)("div",{className:"mt-6 flex flex-col gap-5",children:(0,n.jsxs)("div",{className:"text-black",children:[(0,n.jsx)("p",{children:"Did you know that you can use your native language to ask questions?"}),(0,n.jsx)("p",{className:"mt-2 italic text-[#0039FF]/50",children:'E.g. "How do I say that I am traveling to Portugal soon?"'})]})})]})})}),(0,n.jsx)(S.y.Backdrop,{onTap:s})]})},C=e=>{let{isOpen:t,onClose:s,inputBar:a}=e;return(0,n.jsxs)(S.y,{isOpen:t,onClose:s,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},disableDrag:!0,children:[(0,n.jsxs)(S.y.Container,{style:{backgroundColor:"#FAFBFF"},children:[(0,n.jsx)(S.y.Header,{}),(0,n.jsx)(S.y.Content,{children:(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center pb-16 pt-4",children:[(0,n.jsx)("p",{className:"text-lg font-semibold",children:"Speak again..."}),(0,n.jsx)("p",{className:"mb-6 mt-2 text-black/30",children:"Tap and hold the button"}),a]})})]}),(0,n.jsx)(S.y.Backdrop,{onTap:s})]})};function k(){var e,t,s,i,o,c,d,S;let k=(0,r.useSearchParams)().get("session_id"),{startRecording:P,stopRecording:F,playRecording:_,stopPlayback:R,isPracticeRecording:O,isPlayingAudio:D}=(0,v.I)(),[I,L]=(0,a.useState)(0),[M,B]=(0,a.useState)(!1),[V,W]=(0,a.useState)(0),[U,G]=(0,a.useState)(null),[H,Q]=(0,a.useState)(""),[q,Y]=(0,a.useState)(null),K=(0,l.MV)("AUDIO_CALL",{status:"BACKEND_DISCONNECTED",mode:"Beginner",showStreakPlus:!1,xp:0,startTime:new Date().toISOString(),speedPreference:"NORMAL",lessonInfo:{},saved:[]}),z=(0,l.MV)("STT",{requirePcm:void 0,totalTranscript:"",currTranscript:"",tempTranscript:""}),Z=(0,l.MV)("CHAT",{messages:[],userPreview:null,assistantPreview:null}),J=(0,l.MV)("TTS",{volumeMultiplier:1}),[X]=(0,a.useState)(1);(0,a.useEffect)(()=>((async()=>{try{await g.P.keepAwake()}catch(e){console.error("Failed to enable keep-awake",e)}})(),()=>{(async()=>{await g.P.allowSleep()})()}),[]);let{startSpeaker:$,isPlaying:ee,latestAudioId:et,latestCharIndex:es}=(0,f.Z)({onPlaybackChange:(e,t)=>{J.sendAction({type:e?"PLAYBACK_STARTED":"PLAYBACK_FINISHED",id:t})},volume:J.volumeMultiplier,speed:X}),en=(e,t)=>void 0==e||null==es?"":t?t.length>0?e.slice(0,es*e.length/t.length):e:e.slice(0,es),[ea,el]=(0,a.useState)(!1),ei=(0,r.useRouter)(),[eo,er]=(0,a.useState)(!0),[ec,ed]=(0,a.useState)(!0),[eu,em]=(0,a.useState)(!1),[ex,eh]=(0,a.useState)(!1),[ep,ef]=(0,a.useState)(!0),{isRecording:eg,setRecording:ev,cancelRecording:ej,isVoiceDetected:ey,acquireMic:ew,releaseMic:eb}=(0,p.Z)({onAudioData:e=>{if(!z.requirePcm){if(0==e.byteLength){console.warn("Empty audio blob received");return}z.sendBinary({type:"STREAM_MIC"},e)}},onPCMData(e){if(z.requirePcm){if(0===e.byteLength){console.warn("Empty pcm data received");return}z.sendBinary({type:"STREAM_PCM"},e)}},onRecordingStart:()=>{"Realtime"!=K.mode&&z.sendAction({type:"PTT_PRESSED"})},onRecordingStop:e=>{"Realtime"!=K.mode&&(e?z.sendAction({type:"PTT_CANCELLED"}):z.sendAction({type:"PTT_RELEASED"}))},onSpeechStart:()=>{console.log("speech start"),z.sendAction({type:"VAD_CHANGED",detected:!0})},onSpeechEnd:()=>{console.log("speech end"),z.sendAction({type:"VAD_CHANGED",detected:!1})},micVolume:"Realtime"==K.mode&&ep?0:1,recordingChunkSize:100}),eN=parseInt(null!==(S=null==et?void 0:et.slice(1))&&void 0!==S?S:"")>=Z.messages.length,eS=(0,a.useMemo)(()=>Z.messages.concat(Z.userPreview?[{role:"user",content:Z.userPreview}]:[]).concat(Z.assistantPreview&&eN?[{role:"assistant",content:Z.assistantPreview}]:[]),[Z.messages,Z.userPreview,Z.assistantPreview,eN]),eA=(0,l.MV)("TRANSLATION",{wordForWord:{},translations:{}}),[eT]=(0,l.tp)("CORRECTION",(e,t)=>{if("PERFECT"===t.type){if("Advanced"!==K.mode&&B(!0),!ee&&!eg&&!O){let e=new Audio("encouragement.mp3");e.volume=.5,e.play()}setTimeout(()=>{B(!1)},1200)}},{corrections:{}}),eE=(0,l.MV)("AUTOCOMPLETE",{suggestions:[],translations:[],wordForWord:[],saved:[]}),eC=(0,a.useRef)(null),ek=(0,a.useRef)(null),[eP,eF]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let e=()=>{if(ek.current){let{scrollTop:e,scrollHeight:t,clientHeight:s}=ek.current;e+s>=t&&eF(!1)}},t=ek.current;return t&&t.addEventListener("scroll",e),()=>{t&&t.removeEventListener("scroll",e)}},[]),(0,a.useEffect)(()=>{if(eP)return;eC.current&&cancelAnimationFrame(eC.current);let e=document.getElementById("CHAT_BOTTOM");return e&&(eC.current=requestAnimationFrame(()=>{e.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})})),()=>{eC.current&&cancelAnimationFrame(eC.current)}},[eS,eA]),(0,a.useEffect)(()=>{L(eS.length/12)},[eS]),(0,a.useEffect)(()=>{"CONNECTED"!=K.status&&"BACKEND_DISCONNECTED"!=K.status&&(ea||(console.log("Auto starting lesson"),el(!0),$(()=>{K.sendAction({type:"START_CALL"})},()=>{alert("Failed to start speaker")}),ew(),"Realtime"==K.mode&&ev(!0),ef(!1)))},[K.status]);let[e_,eR]=(0,a.useState)(!1);return(0,n.jsxs)("div",{className:"flex h-full flex-col items-center tracking-[-0.02em]",children:[(0,n.jsx)(y.e,{isOpen:null!==U,onClose:()=>{W(0),G(null),Y(null)},detailedTranslation:"message"===U?{wordForWord:eA.wordForWord[V],translation:eA.translations[V]}:{wordForWord:eE.wordForWord[V],translation:eE.translations[V]},isTTSPlaying:ee&&"e"==et,onTTSPlay:e=>{$(),H&&J.sendAction({type:"SAY",text_stream:null!=e?e:H,id:"e"})},isPracticeRecording:O,setPracticeRecording:e=>{e?P():F()},isPracticePlaying:D,setPracticePlaying:e=>{e?_():R()},onSave:null!=q?q:void 0,isSaved:"message"===U?K.saved[V]:"suggestion"===U?eE.saved[V]:void 0}),(0,n.jsx)(A,{isOpen:e_,onClose:()=>{eR(!1)}}),(0,n.jsx)(C,{isOpen:ex,onClose:()=>{eh(!1)},inputBar:(0,n.jsx)(T.y,{onStartPress:()=>{},onEndPress:()=>{},onCancel:()=>{}})}),(0,n.jsx)(E,{isOpen:eu,onClose:()=>em(!1)}),(0,n.jsx)("div",{className:"flex w-full flex-col items-center px-7 pb-2",children:(0,n.jsxs)("div",{className:"flex w-full items-center justify-between px-1",children:[(0,n.jsx)("button",{className:"flex h-12 items-center justify-center self-start rounded-full text-black",onClick:()=>{el(!1),console.log("audioCall.showStreakPlus",K.showStreakPlus);let e=eS.filter(e=>"user"===e.role).reduce((e,t)=>e+t.content.split(" ").length,0);K.sendAction({type:"STOP_CALL"});let t=Math.ceil((new Date().getTime()-new Date(K.startTime).getTime())/1e3/60),s=new URLSearchParams({streakPlus:K.showStreakPlus.toString(),xp:K.xp.toString(),wordCount:e.toString(),minutes:t.toString()});ei.push("/lessoncomplete?".concat(s.toString()))},children:(0,n.jsx)(b._0w,{className:"text-xl"})}),(0,n.jsx)("div",{className:"mx-5 h-1.5 flex-grow overflow-hidden rounded-full bg-[#D9D9D9]",children:(0,n.jsx)("div",{className:"h-full rounded-full bg-[#0039FF] transition-all duration-300 ease-out",style:{width:"".concat(100*I,"%")}})}),(0,n.jsx)("button",{className:"flex h-12 items-center justify-center self-start rounded-full text-black/30",onClick:()=>{eR(!0)},children:(0,n.jsx)(b.kvo,{className:"text-xl"})})]})}),(0,n.jsxs)("div",{className:"w-full flex-grow overflow-auto overscroll-contain px-7 pt-1",onTouchStart:()=>eF(!0),ref:ek,children:[eS.length>0&&"Realtime"!==K.mode&&eS.map((e,t)=>{var s,a;let l=ee&&"r".concat(t.toString())==et,i=eN&&"l".concat(t.toString())==et,o=l||i;if((null==e?void 0:e.role)==="assistant")return(0,n.jsx)(w.nQ,{profilePicture:null===(a=K.lessonInfo)||void 0===a?void 0:null===(s=a.tutor)||void 0===s?void 0:s.profile_picture_url,isPlaying:o,message:"Advanced"!=K.mode&&ec?o?en(e.content):e.content:void 0,translation:"Advanced"!=K.mode&&ec?o?en(eA.translations[t],e.content):eA.translations[t]:void 0,onTap:()=>{i||(eA.sendAction({type:"REQUEST_WORD_FOR_WORD",index:t}),Q(e.content),W(t),G("message"),Y(()=>e=>{K.sendAction({type:e?"DELETE_MESSAGE":"SAVE_MESSAGE",index:t})}))},onTTSPlay:()=>{$(),J.sendAction({type:"SAY",text_stream:null==e?void 0:e.content,id:"r".concat(t)})},onTTSStop:()=>{$(),J.sendAction({type:"STOP",id:"r".concat(t)})},onTranslate:e=>{e&&(eA.translations[t]||eA.sendAction({type:"REQUEST_TRANSLATION",index:t}))},defaultShowTranslation:"Beginner"==K.mode},t);if((null==e?void 0:e.role)==="user"){let s=eT.corrections[t];return(0,n.jsx)(w.MI,{message:e.content,translation:eA.translations[t],correction:s,onTap:()=>{i||(eA.sendAction({type:"REQUEST_WORD_FOR_WORD",index:t}),Q(e.content),W(t),G("message"),Y(()=>()=>{K.sendAction({type:"SAVE_MESSAGE",index:t})}))},onTranslate:e=>{e&&(eA.translations[t]||eA.sendAction({type:"REQUEST_TRANSLATION",index:t}))},onRedo:()=>{console.log("redoing"),eh(!0)},defaultShowTranslation:"Beginner"==K.mode},t)}}),"Realtime"==K.mode&&(0,n.jsxs)("div",{className:"flex h-full flex-col items-center justify-center",children:[(0,n.jsxs)("div",{className:"mb-16 flex w-full flex-col items-center gap-2 rounded-xl border-[1px] border-black/10 bg-white py-6",children:[(0,n.jsx)("img",{src:null===(t=K.lessonInfo)||void 0===t?void 0:null===(e=t.tutor)||void 0===e?void 0:e.profile_picture_url,alt:"",className:"h-20 w-20"}),(0,n.jsx)("div",{className:"text-lg font-medium",children:null===(i=K.lessonInfo)||void 0===i?void 0:null===(s=i.lesson)||void 0===s?void 0:s.title}),(0,n.jsx)("div",{className:"text-3xl",children:null===(c=K.lessonInfo)||void 0===c?void 0:null===(o=c.lesson)||void 0===o?void 0:o.emoji}),(0,n.jsx)("div",{className:"rounded-md bg-[#0039FF]/10 p-2 text-[#0039FF]",children:"Real time call"})]}),(0,n.jsx)("div",{className:"mx-8 text-center text-sm text-black/30",children:"Caution: This mode is experimental and may not work as expected."})]}),(0,n.jsx)("div",{id:"CHAT_BOTTOM"})]}),(0,n.jsx)("div",{className:"pointer-events-none w-full justify-end gap-5 tracking-[-0.02em]",children:(0,n.jsxs)("div",{className:"pointer-events-auto flex w-full flex-col gap-4 pb-10 pt-4 ".concat("Realtime"==K.mode?"":"border-t-[1px] border-black/10 bg-white"),children:[(0,n.jsx)(u.M,{mode:"wait",children:M&&!eg?(0,n.jsxs)(m.E.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.3},className:"flex h-[10.75rem] flex-col items-center justify-center gap-5",children:[(0,n.jsx)(m.E.div,{initial:{y:-20},animate:{y:0},transition:{delay:.1,type:"spring",stiffness:300},className:"flex gap-2",children:[0,1,2].map(e=>(0,n.jsx)(m.E.div,{initial:{opacity:0,rotate:-180},animate:{opacity:1,rotate:0},transition:{delay:.1*e,duration:.3},children:(0,n.jsx)(b.QJe,{className:"text-[#0039FF]"})},e))}),(0,n.jsx)(m.E.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4,duration:.3},children:"Amazing \uD83E\uDD73"})]},"encouragement"):eS.length>0&&"Realtime"!==K.mode&&"Advanced"!==K.mode?(0,n.jsxs)(m.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[(0,n.jsx)("div",{className:"mb-1 flex justify-center text-base font-light text-black/30",onClick:()=>{er(!eo)},children:(0,n.jsx)(m.E.div,{animate:{rotateX:eo?0:180},transition:{duration:.6,ease:"easeInOut"},children:(0,n.jsx)(b.RiI,{className:"scale-y-75 transform"})})}),(0,n.jsx)(u.M,{children:eo&&(0,n.jsx)(m.E.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3,ease:"easeInOut",opacity:{duration:.05,ease:"easeInOut"},height:{duration:.3,ease:"easeInOut"}},className:"overflow-hidden",children:(0,n.jsx)("div",{className:"h-32",children:(0,n.jsx)(x.tq,{pagination:!0,modules:[h.tl],className:"w-screen bg-white",children:(null===(d=eE.suggestions)||void 0===d?void 0:d.length)>=3?eE.suggestions.map((e,t)=>(0,n.jsx)(x.o5,{className:"mb-4 !h-auto px-6 py-2",children:(0,n.jsxs)("button",{onClick:()=>{Q(e),W(t),G("suggestion"),Y(()=>e=>{console.log("saving suggestion"),eE.sendAction({type:e?"DELETE_SUGGESTION":"SAVE_SUGGESTION",index:t})})},className:"flex h-full w-full flex-col items-center rounded-lg bg-white p-4 shadow-custom-shadow",children:["Intermediate"===K.mode||"Advanced"===K.mode?(0,n.jsx)("div",{className:"flex flex-wrap gap-1 gap-y-5",children:eE.wordForWord[t]&&eE.wordForWord[t].length>0&&eE.wordForWord[t].map((e,t)=>(0,n.jsx)("div",{className:"flex flex-col items-center",children:(0,n.jsx)("div",{className:"mb-1 text-nowrap rounded-sm bg-black/5 px-1 font-normal text-black/0",children:e.original})},t))}):(0,n.jsx)("div",{className:"w-full overflow-hidden overflow-ellipsis whitespace-nowrap",children:(0,j.f)(e)}),(0,n.jsx)("div",{className:"w-full overflow-hidden overflow-ellipsis whitespace-nowrap text-sm text-black/30",children:(0,j.f)(eE.translations[t])})]})},t)):(0,n.jsx)(n.Fragment,{children:Array.from({length:3}).map((e,t)=>(0,n.jsx)(x.o5,{className:"mb-4 !h-auto px-6 py-2",children:(0,n.jsx)("div",{className:"h-full w-full rounded-lg bg-white p-4 shadow-custom-shadow",children:(0,n.jsxs)("div",{className:"flex w-full flex-col items-center space-y-2",children:[(0,n.jsx)("div",{className:"animate-shimmer h-5 w-2/3 rounded bg-gray-200"}),(0,n.jsx)("div",{className:"animate-shimmer h-5 w-2/3 rounded bg-gray-200"})]})})},t))})})})})})]},"messages"):null}),"CONNECTED"!==K.status?(0,n.jsx)("button",{className:"mx-8 flex h-[3.6rem] flex-grow items-center justify-center rounded-full bg-[#0039FF] px-4 font-bold text-white",onClick:()=>{ea||(el(!0),$(()=>{K.sendAction({type:"START_CALL"})},()=>{alert("Failed to start speaker")}),ew(),"Realtime"==K.mode&&ev(!0),ef(!1))},children:(0,n.jsx)(b.fCD,{className:"animate-spin"})}):"Realtime"==K.mode?(0,n.jsxs)("div",{className:"mx-8 flex w-full items-center justify-between",children:[(0,n.jsxs)("button",{className:"relative flex h-14 w-14 items-center justify-center rounded-full bg-black/5 ".concat(ey?"ring-4":""," ").concat(ep?"ring-red-500/70":"ring-green-500/70"),onClick:()=>{$(),eg||ev(!0),ef(!ep)},children:[(0,n.jsx)(N.J,{icon:ep?b.uYL:b.RgM,className:"text-xl text-black"}),ey&&ep&&(0,n.jsx)("p",{className:"absolute -right-[120px] -top-8 rounded-full rounded-bl-none bg-black/5 p-2 text-sm",children:"Press to unmute"})]}),(0,n.jsx)("button",{className:"flex h-14 w-14 items-center justify-center rounded-full bg-black/5",onClick:()=>{el(!1),K.sendAction({type:"STOP_CALL"}),console.log("audioCall.showStreakPlus",K.showStreakPlus),ei.push("/feedback?session_id=".concat(k))},children:(0,n.jsx)(b._0w,{className:"text-xl text-black"})})]}):(0,n.jsx)(T.y,{onStartPress:()=>{ev(!0),ef(!1)},onEndPress:()=>{ev(!1),$(),eF(!1)},onCancel:()=>{ej()},viewText:ec,setViewText:ed,viewQuestion:eu,setViewQuestion:em})]})})]})}function P(){return(0,n.jsx)(d,{children:(0,n.jsx)("main",{className:"h-screen-safe bg-[#FAFBFF] pt-1",children:(0,n.jsx)(k,{})})})}}},function(e){e.O(0,[2284,7240,6051,4753,254,755,4272,5563,3069,4438,1310,3370,3386,2971,2117,1744],function(){return e(e.s=3658)}),_N_E=e.O()}]);