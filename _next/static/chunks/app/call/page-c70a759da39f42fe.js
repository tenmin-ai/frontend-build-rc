(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2293],{3658:function(e,t,s){Promise.resolve().then(s.bind(s,8653))},8653:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return C}});var n=s(7437),l=s(2265),a=s(4272),i=s(3974),o=s(3772),r=s(9376),c=s(9403);function d(e){let{children:t}=e,s=(0,i.useIsClient)(),{token:l}=(0,c.f)(),d=(0,r.useSearchParams)().get("session_id");return d?s?(0,n.jsx)(a.eA,{url:"".concat("wss://backend-us-rc.tenmin.ai","/ws/lesson/").concat(d,"?token=").concat(l),label:"Call",toast:o.A,autoconnect:!0,wsAuth:!0,binaryType:"arraybuffer",children:t}):(0,n.jsx)("div",{children:"Loading.."}):(0,n.jsx)("div",{children:"Invalid lesson"})}var u=s(5095),m=s(755),x=s(9764);s(7354),s(6889);var h=s(3377),f=s(3510),p=s(3399),g=s(5123),v=s(1755),w=s(434),j=s(386),y=s(5040),N=s(1273),b=s(2859),T=s(3069);let A=e=>{let{isOpen:t,onClose:s}=e,[a,i]=(0,l.useState)([]),o=async()=>{i((await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind))};(0,l.useEffect)(()=>{o(),navigator.mediaDevices&&void 0!==navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=o);let e=a.find(e=>e.label.includes("AirPods"));e&&c(e.deviceId)},[]),(0,l.useEffect)(()=>{let e=setInterval(()=>{o()},1e3);return()=>clearInterval(e)},[]);let{selectedMic:r,acquireMic:c,isVoiceDetected:d}=(0,f.Z)({recordingChunkSize:100});return(0,n.jsxs)(T.y,{isOpen:t,onClose:s,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,n.jsx)(T.y.Container,{style:{backgroundColor:"#FAFBFF"},children:(0,n.jsx)(T.y.Content,{children:(0,n.jsxs)("div",{className:"p-8 pb-16 text-black w-full",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("p",{className:"font-semibold text-lg ",children:"Settings"}),(0,n.jsx)("div",{className:"flex gap-3",children:(0,n.jsx)(N._0w,{onClick:s})})]}),(0,n.jsxs)("div",{className:"flex flex-col gap-5 mt-6",children:[(0,n.jsx)("div",{className:"flex items-center gap-2 text-black",children:(0,n.jsx)("p",{children:"Your Microphone"})}),(0,n.jsx)("div",{className:"flex flex-col gap-2",children:a.map(e=>(0,n.jsx)("button",{className:"flex items-center justify-between py-3 px-3 w-full rounded-lg font-normal border ".concat(r==e.deviceId?"border-[#0039FF] text-[#0039FF] bg-[#0039FF]/5":"bg-white"),onClick:()=>{c(e.deviceId)},children:(0,n.jsx)("p",{className:"text-sm",children:e.label||"Unknown Microphone"})},e.deviceId))}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-sm text-black/30 mb-12",children:[(0,n.jsx)("p",{children:"Try speaking to test your microphone:"}),(0,n.jsx)("div",{className:"flex items-center justify-center rounded-full h-1 w-8 ".concat(d?"bg-green-500":"bg-black/10")})]})]})]})})}),(0,n.jsx)(T.y.Backdrop,{onTap:s})]})};var S=s(4502);function k(){var e,t,s,i,o,c,d,T;(0,r.useSearchParams)().get("session_id");let{startRecording:k,stopRecording:C,playRecording:E,stopPlayback:P,isPracticeRecording:R,isPlayingAudio:_}=(0,v.I)(),[F,O]=(0,l.useState)(0),[D,I]=(0,l.useState)(!1),[L,M]=(0,l.useState)(null),[B,W]=(0,l.useState)(""),V=(0,a.MV)("AUDIO_CALL",{status:"BACKEND_DISCONNECTED",mode:"Beginner",showStreakPlus:!1,speedPreference:"NORMAL",lessonInfo:{}}),U=(0,a.MV)("STT",{totalTranscript:"",currTranscript:"",tempTranscript:""}),H=(0,a.MV)("CHAT",{messages:[],userPreview:null,assistantPreview:null}),Q=(0,a.MV)("TTS",{volumeMultiplier:1}),Y=(0,a.MV)("TRANSLATION",{wordForWord:{},translations:{}}),[z]=(0,a.tp)("CORRECTION",(e,t)=>{"PERFECT"===t.type&&("Advanced"!==V.mode&&I(!0),setTimeout(()=>{let e=new Audio("encouragement.mp3");e.volume=.5,e.play()},500),setTimeout(()=>{I(!1)},1200))},{corrections:{}}),K=(0,a.MV)("AUTOCOMPLETE",{suggestions:[],translations:[],wordForWord:[]}),[Z]=(0,l.useState)(1);(0,l.useEffect)(()=>((async()=>{await g.P.keepAwake()})(),()=>{(async()=>{await g.P.allowSleep()})()}),[]);let{startSpeaker:G,isPlaying:J,latestAudioId:q,latestCharIndex:X}=(0,p.Z)({onPlaybackChange:(e,t)=>{Q.sendAction({type:e?"PLAYBACK_STARTED":"PLAYBACK_FINISHED",id:t})},volume:Q.volumeMultiplier,speed:Z}),$=(e,t)=>void 0==e||null==X?"":t?t.length>0?e.slice(0,X*e.length/t.length):e:e.slice(0,X),[ee,et]=(0,l.useState)(!1),es=(0,r.useRouter)(),[en,el]=(0,l.useState)(!0),[ea,ei]=(0,l.useState)(!0),[eo,er]=(0,l.useState)(!0),{isRecording:ec,setRecording:ed,cancelRecording:eu,isVoiceDetected:em,acquireMic:ex,releaseMic:eh}=(0,f.Z)({onAudioData:async e=>{0!=e.size&&U.sendBinary({type:"STREAM_MIC"},await e.arrayBuffer())},onRecordingStart:()=>{"Realtime"!=V.mode&&U.sendAction({type:"PTT_PRESSED"})},onRecordingStop:e=>{"Realtime"!=V.mode&&(e?U.sendAction({type:"PTT_CANCELLED"}):U.sendAction({type:"PTT_RELEASED"}))},onSpeechStart:()=>{console.log("speech start"),U.sendAction({type:"VAD_CHANGED",detected:!0})},onSpeechEnd:()=>{console.log("speech end"),U.sendAction({type:"VAD_CHANGED",detected:!1})},micVolume:"Realtime"==V.mode&&eo?0:1,recordingChunkSize:100}),ef=parseInt(null!==(T=null==q?void 0:q.slice(1))&&void 0!==T?T:"")>=H.messages.length,ep=(0,l.useMemo)(()=>H.messages.concat(H.userPreview?[{role:"user",content:H.userPreview}]:[]).concat(H.assistantPreview&&ef?[{role:"assistant",content:H.assistantPreview}]:[]),[H.messages,H.userPreview,H.assistantPreview,ef]);(0,l.useEffect)(()=>{let e=document.getElementById("CHAT_BOTTOM");e&&e.scrollIntoView({behavior:"smooth"})},[ep,Y]),(0,l.useEffect)(()=>{O(ep.length/12)},[ep]),(0,l.useEffect)(()=>{"CONNECTED"!=V.status&&"BACKEND_DISCONNECTED"!=V.status&&(ee||(console.log("Auto starting lesson"),et(!0),G(()=>{V.sendAction({type:"START_CALL"})},()=>{alert("Failed to start speaker")}),ex(),"Realtime"==V.mode&&ed(!0),er(!1)))},[V.status]);let[eg,ev]=(0,l.useState)(!1);return(0,n.jsxs)("div",{className:"flex flex-col h-full items-center tracking-[-0.02em] ",children:[(0,n.jsx)(j.e,{isOpen:null!==L,onClose:()=>M(null),detailedTranslation:"number"==typeof L?{wordForWord:Y.wordForWord[L],translation:Y.translations[L]}:L,isTTSPlaying:J&&"e"==q,onTTSPlay:e=>{G(),B&&Q.sendAction({type:"SAY",text_stream:null!=e?e:B,id:"e"})},isPracticeRecording:R,setPracticeRecording:e=>{e?k():C()},isPracticePlaying:_,setPracticePlaying:e=>{e?E():P()}}),(0,n.jsx)(A,{isOpen:eg,onClose:()=>{ev(!1)}}),(0,n.jsx)("div",{className:"flex flex-col items-center w-full pb-2 px-7",children:(0,n.jsxs)("div",{className:"flex w-full justify-between items-center px-1",children:[(0,n.jsx)("button",{className:"text-black self-start flex items-center h-12 justify-center rounded-full",onClick:()=>{et(!1),console.log("audioCall.showStreakPlus",V.showStreakPlus),V.sendAction({type:"STOP_CALL"}),V.showStreakPlus?es.push("/streakPlus"):es.push("/")},children:(0,n.jsx)(N._0w,{className:"text-xl"})}),(0,n.jsx)("div",{className:" mx-5 h-1.5 flex-grow bg-[#D9D9D9] rounded-full overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-[#0039FF] rounded-full transition-all duration-300 ease-out",style:{width:"".concat(100*F,"%")}})}),(0,n.jsx)("button",{className:" text-black/30 self-start flex items-center h-12 justify-center rounded-full",onClick:()=>{ev(!0)},children:(0,n.jsx)(N.kvo,{className:"text-xl"})})]})}),(0,n.jsxs)("div",{className:"flex-grow w-full overflow-auto overscroll-contain px-7 pt-1",children:[ep.length>0&&"Realtime"!==V.mode&&ep.map((e,t)=>{var s,l;let a=J&&"r".concat(t.toString())==q,i=ef&&"l".concat(t.toString())==q,o=a||i;if((null==e?void 0:e.role)==="assistant")return(0,n.jsx)(y.nQ,{profilePicture:null===(l=V.lessonInfo)||void 0===l?void 0:null===(s=l.tutor)||void 0===s?void 0:s.profile_picture_url,isPlaying:o,message:"Advanced"!=V.mode&&ea?o?$(e.content):e.content:void 0,translation:"Advanced"!=V.mode&&ea?o?$(Y.translations[t],e.content):Y.translations[t]:void 0,onTap:()=>{i||(Y.sendAction({type:"REQUEST_WORD_FOR_WORD",index:t}),W(e.content),M(t))},onTTSPlay:()=>{G(),Q.sendAction({type:"SAY",text_stream:null==e?void 0:e.content,id:"r".concat(t)})},onTTSStop:()=>{G(),Q.sendAction({type:"STOP",id:"r".concat(t)})},onTranslate:e=>{e&&(Y.translations[t]||Y.sendAction({type:"REQUEST_TRANSLATION",index:t}))},defaultShowTranslation:"Beginner"==V.mode},t);if((null==e?void 0:e.role)==="user"){let s=z.corrections[t];return(0,n.jsx)(y.MI,{message:e.content,translation:Y.translations[t],correction:s,onTap:()=>{i||(Y.sendAction({type:"REQUEST_WORD_FOR_WORD",index:t}),W(e.content),M(t))},onTranslate:e=>{e&&(Y.translations[t]||Y.sendAction({type:"REQUEST_TRANSLATION",index:t}))},defaultShowTranslation:"Beginner"==V.mode},t)}}),"Realtime"==V.mode&&(0,n.jsxs)("div",{className:"h-full flex flex-col justify-center items-center",children:[(0,n.jsxs)("div",{className:"bg-white flex flex-col items-center rounded-xl border-black/10 border-[1px] py-6 gap-2 mb-16 w-full",children:[(0,n.jsx)("img",{src:null===(t=V.lessonInfo)||void 0===t?void 0:null===(e=t.tutor)||void 0===e?void 0:e.profile_picture_url,alt:"",className:"w-20 h-20"}),(0,n.jsx)("div",{className:"font-medium text-lg",children:null===(i=V.lessonInfo)||void 0===i?void 0:null===(s=i.lesson)||void 0===s?void 0:s.title}),(0,n.jsx)("div",{className:"text-3xl",children:null===(c=V.lessonInfo)||void 0===c?void 0:null===(o=c.lesson)||void 0===o?void 0:o.emoji}),(0,n.jsx)("div",{className:"bg-[#0039FF]/10 text-[#0039FF] p-2 rounded-md",children:"Real time call"})]}),(0,n.jsx)("div",{className:"text-black/30 text-center text-sm mx-8",children:"Caution: This mode is experimental and may not work as expected."})]}),(0,n.jsx)("div",{id:"CHAT_BOTTOM"})]}),(0,n.jsx)("div",{className:"w-full justify-end gap-5 tracking-[-0.02em] pointer-events-none",children:(0,n.jsxs)("div",{className:"flex flex-col w-full gap-4 pointer-events-auto pb-10 pt-4   ".concat("Realtime"==V.mode?"":"border-black/10 border-t-[1px] bg-white"),children:[(0,n.jsx)(u.M,{mode:"wait",children:D&&!ec?(0,n.jsxs)(m.E.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.3},className:"flex flex-col items-center gap-5 h-[10.75rem] justify-center",children:[(0,n.jsx)(m.E.div,{initial:{y:-20},animate:{y:0},transition:{delay:.1,type:"spring",stiffness:300},className:"flex gap-2",children:[0,1,2].map(e=>(0,n.jsx)(m.E.div,{initial:{opacity:0,rotate:-180},animate:{opacity:1,rotate:0},transition:{delay:.1*e,duration:.3},children:(0,n.jsx)(N.QJe,{className:"text-[#0039FF]"})},e))}),(0,n.jsx)(m.E.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4,duration:.3},children:"Amazing \uD83E\uDD73"})]},"encouragement"):ep.length>0&&"Realtime"!==V.mode&&"Advanced"!==V.mode?(0,n.jsxs)(m.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[(0,n.jsx)("div",{className:"flex justify-center text-black/30 font-light text-base mb-1",onClick:()=>{el(!en)},children:(0,n.jsx)(m.E.div,{animate:{rotateX:en?0:180},transition:{duration:.6,ease:"easeInOut"},children:(0,n.jsx)(N.RiI,{className:"transform scale-y-75"})})}),(0,n.jsx)(u.M,{children:en&&(0,n.jsx)(m.E.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3,ease:"easeInOut",opacity:{duration:.05,ease:"easeInOut"},height:{duration:.3,ease:"easeInOut"}},className:"overflow-hidden",children:(0,n.jsx)("div",{className:"h-32",children:(0,n.jsx)(x.tq,{pagination:!0,modules:[h.tl],className:"bg-white w-screen",children:(null===(d=K.suggestions)||void 0===d?void 0:d.length)>=3?K.suggestions.map((e,t)=>(0,n.jsx)(x.o5,{className:"!h-auto px-6 py-2 mb-4",children:(0,n.jsxs)("button",{onClick:()=>{W(e),M({wordForWord:K.wordForWord[t],translation:K.translations[t]})},className:"shadow-custom-shadow w-full h-full bg-white p-4 rounded-lg flex flex-col items-center",children:["Intermediate"===V.mode||"Advanced"===V.mode?(0,n.jsx)("div",{className:"flex gap-1 flex-wrap gap-y-5",children:K.wordForWord[t]&&K.wordForWord[t].length>0&&K.wordForWord[t].map((e,t)=>(0,n.jsx)("div",{className:"flex flex-col items-center",children:(0,n.jsx)("div",{className:"font-normal px-1 bg-black/5 rounded-sm mb-1 text-nowrap text-black/0",children:e.original})},t))}):(0,n.jsx)("div",{className:"w-full *:overflow-hidden overflow-ellipsis whitespace-nowrap",children:(0,w.f)(e)}),(0,n.jsx)("div",{className:"w-full text-black/30 overflow-hidden overflow-ellipsis whitespace-nowrap",children:(0,w.f)(K.translations[t])})]})},t)):(0,n.jsx)(n.Fragment,{children:Array.from({length:3}).map((e,t)=>(0,n.jsx)(x.o5,{className:"!h-auto px-6 py-2 mb-4",children:(0,n.jsx)("div",{className:"shadow-custom-shadow w-full h-full bg-white p-4 rounded-lg",children:(0,n.jsxs)("div",{className:"space-y-2 w-full flex flex-col items-center",children:[(0,n.jsx)("div",{className:"w-2/3 h-5 bg-gray-200 rounded animate-shimmer"}),(0,n.jsx)("div",{className:"w-2/3 h-5 bg-gray-200 rounded animate-shimmer"})]})})},t))})})})})})]},"messages"):null}),"CONNECTED"!==V.status?(0,n.jsx)("button",{className:" bg-[#0039FF] mx-8 text-white font-bold px-4 h-[3.6rem] flex-grow rounded-full flex items-center justify-center",onClick:()=>{ee||(et(!0),G(()=>{V.sendAction({type:"START_CALL"})},()=>{alert("Failed to start speaker")}),ex(),"Realtime"==V.mode&&ed(!0),er(!1))},children:(0,n.jsx)(N.fCD,{className:"animate-spin"})}):"Realtime"==V.mode?(0,n.jsxs)("div",{className:"flex items-center justify-between w-full mx-8",children:[(0,n.jsxs)("button",{className:"relative bg-black/5 h-14 w-14 rounded-full flex items-center justify-center ".concat(em?"ring-4":""," ").concat(eo?"ring-red-500/70":"ring-green-500/70"),onClick:()=>{G(),ec||ed(!0),er(!eo)},children:[(0,n.jsx)(b.J,{icon:eo?N.uYL:N.RgM,className:"text-black text-xl"}),em&&eo&&(0,n.jsx)("p",{className:"absolute -right-[120px] -top-8 bg-black/5 rounded-full rounded-bl-none p-2 text-sm",children:"Press to unmute"})]}),(0,n.jsx)("button",{className:"bg-black/5 h-14 w-14 rounded-full flex items-center justify-center",onClick:()=>{et(!1),V.sendAction({type:"STOP_CALL"}),console.log("audioCall.showStreakPlus",V.showStreakPlus),V.showStreakPlus?es.push("/streakPlus"):es.push("/")},children:(0,n.jsx)(N._0w,{className:"text-black text-xl"})})]}):(0,n.jsx)(S.y,{onStartPress:()=>{ed(!0),er(!1)},onEndPress:()=>{ed(!1),G()},onCancel:()=>{eu()},viewText:ea,setViewText:ei})]})})]})}function C(){return(0,n.jsx)(d,{children:(0,n.jsx)("main",{className:"bg-[#FAFBFF] h-screen-safe pt-1",children:(0,n.jsx)(k,{})})})}}},function(e){e.O(0,[2284,7240,6051,4753,254,6990,4272,5563,4438,3069,8046,3386,515,2971,2117,1744],function(){return e(e.s=3658)}),_N_E=e.O()}]);