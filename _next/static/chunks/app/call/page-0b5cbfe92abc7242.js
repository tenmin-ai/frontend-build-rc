(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[293],{3658:function(e,t,n){Promise.resolve().then(n.bind(n,4122))},4122:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return T}});var r=n(7437),s=n(2265),l=n(4031),a=n(3061),c=n(7776),i=n(6463);let o=()=>{let[e,t]=(0,a.useLocalStorage)("token");return{token:e,saveToken:t}};function u(e){let{children:t}=e,n=(0,a.useIsClient)(),{token:s,saveToken:u}=o(),d=(0,i.useSearchParams)().get("session_id");return d?n?(0,r.jsx)(l.eA,{url:"wss://backend-us-rc.tenmin.ai/ws"+"/".concat(d)+"?token=".concat(s),label:"Debug Call",toast:c.A,autoconnect:!0,wsAuth:!0,binaryType:"arraybuffer",children:t}):(0,r.jsx)("div",{children:"Loading.."}):(0,r.jsx)("div",{children:"Invalid lesson"})}var d=n(6920),m=n(5127),x=n(2351),f=n(3267);n(3034),n(7322);var h=n(7805),g=n(2793),p=n(5079),v=n(68),w=n(2374),j=n(7743),b=e=>{let{onStartPress:t,onEndPress:n,onCancel:l,cancelButtonRef:a,children:c}=e,[i,o]=(0,s.useState)(!1),u=(0,s.useRef)({x:0,y:0}),d=e=>{if(a.current){let t=a.current.getBoundingClientRect();return e.x>=t.left&&e.x<=t.right&&e.y>=t.top&&e.y<=t.bottom}return!1};return(0,s.useEffect)(()=>{let e=e=>{var t,n;if(!i)return;let r=e.touches[0];d({x:r.clientX,y:r.clientY})?null===(t=a.current)||void 0===t||t.classList.add("scale-110","bg-red-300"):null===(n=a.current)||void 0===n||n.classList.remove("scale-110","bg-red-300")};return window.addEventListener("touchmove",e),()=>{window.removeEventListener("touchmove",e)}},[i,a]),(0,r.jsx)("button",{onTouchStart:e=>{e.preventDefault(),o(!0),t();let n=e.touches[0];u.current={x:n.clientX,y:n.clientY}},onTouchEnd:e=>{e.preventDefault(),o(!1);let t=e.changedTouches[0];d({x:t.clientX,y:t.clientY})?l():n()},onContextMenu:e=>e.preventDefault(),className:"microphoneButton",children:c?c(i):"Press and Hold"})};let N=e=>e||"â€‹";function y(){var e,t;let{startRecording:n,stopRecording:a,playRecording:c,stopPlayback:o,isPracticeRecording:u,isPlayingAudio:y}=function(){let[e,t]=(0,s.useState)(!1),[n,r]=(0,s.useState)(!1),l=(0,s.useRef)(null),a=(0,s.useRef)(null),c=(0,s.useRef)(null),[i,o]=(0,s.useState)(null);return{startRecording:async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0});l.current=e,a.current=new MediaRecorder(e);let n=[];a.current.ondataavailable=e=>{e.data.size>0&&n.push(e.data)},a.current.onstop=()=>{let e=new Blob(n,{type:"audio/mpeg"});o(e),t(!1)},a.current.start(),t(!0)}catch(e){console.error("Error accessing microphone:",e)}},stopRecording:()=>{a.current&&"recording"===a.current.state&&a.current.stop(),l.current&&l.current.getTracks().forEach(e=>e.stop())},playRecording:()=>{i?(c.current||(c.current=new Audio),c.current.src=URL.createObjectURL(i),c.current.play(),r(!0),c.current.onended=()=>{r(!1)}):console.warn("No recording available to play")},stopPlayback:()=>{c.current&&(c.current.pause(),c.current.currentTime=0,r(!1))},isPracticeRecording:e,isPlayingAudio:n}}(),[T,k]=(0,s.useState)(!1),[E,C]=(0,s.useState)(""),[A,S]=(0,s.useState)([]),[R,F]=(0,s.useState)(""),D=(0,l.MV)("AUDIO_CALL",{status:"BACKEND_DISCONNECTED",mode:"Beginner",speedPreference:"NORMAL"}),P=(0,l.MV)("STT",{totalTranscript:"",currTranscript:"",tempTranscript:""}),_=(0,l.MV)("CHAT",{messages:[],userPreview:null,assistantPreview:null}),L=(0,l.MV)("TTS",{}),M=(0,l.MV)("TRANSLATION",{wordForWord:{},translations:{}}),O=(0,l.MV)("AUTOCOMPLETE",{suggestions:[],translations:[],wordForWord:[]}),[G,I]=(0,s.useState)(1);(0,s.useEffect)(()=>((async()=>{await j.P.keepAwake()})(),()=>{(async()=>{await j.P.allowSleep()})()}),[]);let{startSpeaker:U,isPlaying:B,isLagging:V,latestAudioId:H,latestCharIndex:W}=(0,w.Z)({onPlaybackChange:(e,t)=>{L.sendAction({type:e?"PLAYBACK_STARTED":"PLAYBACK_FINISHED",id:t})},volume:1,speed:G}),Y=(e,t)=>void 0==e||null==W?"":t?t.length>0?e.slice(0,W*e.length/t.length):e:e.slice(0,W),[z,K]=(0,s.useState)(!1),X=(0,i.useRouter)(),[Z,q]=(0,s.useState)(!0),{isRecording:J,setRecording:Q,cancelRecording:$,acquireMic:ee,releaseMic:et}=function(e){let{onSpeechStart:t,onSpeechEnd:n,onAudioData:r,onRecordingStart:l,onRecordingStop:a,micVolume:c=1,recordingChunkSize:i}=e,o=(0,s.useRef)(null),u=(0,s.useRef)(null),d=(0,s.useRef)(null),m=(0,s.useRef)(null),[x,f]=(0,s.useState)(!1),h=(0,s.useRef)(!1);(0,s.useEffect)(()=>{x?p():d.current&&w()},[x]);let g=async()=>{o.current=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0}});let e=new AudioContext,r=e.createMediaStreamSource(o.current);u.current=e.createGain(),r.connect(u.current),u.current.gain.value=c;let s=e.createMediaStreamDestination();u.current.connect(s),d.current=new MediaRecorder(s.stream),m.current=await v.MicVAD.new({workletURL:"/vad/vad.worklet.bundle.min.js",modelURL:"/vad/silero_vad.onnx",ortConfig:e=>{e.env.wasm.wasmPaths="/vad/"},stream:o.current,onSpeechStart:()=>{console.log("User started talking"),null==t||t()},onVADMisfire:()=>{console.log("Nvm, user didn't start talking"),null==n||n(!0)},onSpeechEnd:e=>{console.log("User stopped talking"),null==n||n(!1)},positiveSpeechThreshold:.7,negativeSpeechThreshold:.35}),m.current.start()},p=async()=>{if(!d.current)try{await g()}catch(e){console.error("Error accessing microphone:",e)}d.current&&(d.current.ondataavailable=e=>{null==r||r(e.data)},d.current.onstart=()=>{null==l||l()},d.current.onstop=()=>{null==a||a(h.current)},h.current=!1,await d.current.start(i))},w=()=>{d.current&&d.current.stop()},j=()=>{w(),d.current&&(d.current=null),u.current&&(u.current.disconnect(),u.current=null),o.current&&(o.current.getTracks().forEach(e=>e.stop()),o.current=null),m.current&&(m.current.destroy(),m.current=null)};return(0,s.useEffect)(()=>{u.current&&(u.current.gain.value=c)},[c]),(0,s.useEffect)(()=>(g(),j),[]),{isRecording:x,setRecording:f,cancelRecording:()=>{h.current=!0,f(!1)},acquireMic:g,releaseMic:j}}({onAudioData:e=>{0!=e.size&&P.sendBinary({type:"STREAM_MIC"},e)},onRecordingStart:()=>{"Realtime"!=D.mode&&P.sendAction({type:"PTT_PRESSED"})},onRecordingStop:e=>{"Realtime"!=D.mode&&(e?P.sendAction({type:"PTT_CANCELLED"}):P.sendAction({type:"PTT_RELEASED"}))},onSpeechStart:()=>{P.sendAction({type:"VAD_CHANGED",detected:!0})},onSpeechEnd:e=>{P.sendAction({type:"VAD_CHANGED",detected:!1})},micVolume:"Realtime"==D.mode&&Z?0:1,recordingChunkSize:100}),en=parseInt(null!==(t=null==H?void 0:H.slice(1))&&void 0!==t?t:"")>=_.messages.length,er=(0,s.useMemo)(()=>_.messages.concat(_.userPreview?[{role:"user",content:_.userPreview}]:[]).concat(_.assistantPreview&&en?[{role:"assistant",content:_.assistantPreview}]:[]),[_.messages,_.userPreview,_.assistantPreview,en]);(0,s.useEffect)(()=>{let e=document.getElementById("CHAT_BOTTOM");e&&e.scrollIntoView({behavior:"smooth"})},[er.length]);let[es,el]=(0,s.useState)(0),[ea,ec]=(0,s.useState)(!1);(0,s.useEffect)(()=>{el(er.length/12)},[er]),(0,s.useEffect)(()=>{"CONNECTED"!=D.status&&"BACKEND_DISCONNECTED"!=D.status&&(z||(console.log("Auto starting lesson"),K(!0),D.sendAction({type:"START_CALL"}),U(),ee(),"Realtime"==D.mode&&Q(!0),q(!1)))},[D.status]);let ei=(0,s.useRef)(null);return(0,r.jsxs)("div",{className:"flex flex-col h-full items-center tracking-[-0.02em] ",children:[(0,r.jsxs)(g.y,{isOpen:T,onClose:()=>k(!1),detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,r.jsx)(g.y.Container,{children:(0,r.jsx)(g.y.Content,{style:{backgroundImage:"white"},children:(0,r.jsxs)("div",{className:"p-8 pb-16 text-black w-full",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("p",{className:"font-semibold text-lg ",children:"Explanation"}),(0,r.jsx)("div",{className:"flex gap-3",children:(0,r.jsx)(d.G,{icon:p.EOp,onClick:()=>k(!1)})})]}),(0,r.jsx)("div",{className:"flex gap-1 mt-4 flex-wrap gap-y-5",children:A&&A.length>0&&A.map((e,t)=>(0,r.jsxs)("div",{className:"flex flex-col items-center",children:[(0,r.jsx)("div",{className:"font-normal text-xl px-1 bg-black/5 rounded-sm mb-1 text-nowrap",children:e.original}),(0,r.jsx)("div",{className:"text-black px-1 bg-black/5 rounded-sm text-nowrap",children:e.translation})]},t))}),(0,r.jsxs)("div",{className:"mt-6 flex items-center gap-2 text-black/30",children:[(0,r.jsx)("div",{className:"material-symbols-rounded !text-xl",children:"translate"}),(0,r.jsx)("div",{children:R})]}),(0,r.jsxs)("div",{className:"flex mt-10 justify-center gap-6 mx-10",children:[(0,r.jsxs)("div",{className:"flex flex-col items-center gap-2 flex-1 w-16",children:[(0,r.jsx)("button",{onClick:()=>{U(),E&&L.sendAction({type:"SAY",text_stream:E,id:"e"})},className:"shadow-custom-blue-shadow bg-white rounded-full p-4 h-14 w-14 flex justify-center items-center",children:(0,r.jsx)(d.G,{className:"text-[#0039FF] text-lg",icon:B&&"e"==H?p.Bg$:p.zc})}),(0,r.jsx)("div",{className:"text-sm",children:"Play"})]}),(0,r.jsxs)("div",{className:"flex flex-col items-center gap-2 flex-1 w-16",children:[(0,r.jsx)("button",{onClick:u?a:n,className:"shadow-custom-blue-shadow bg-[#0039FF] rounded-full p-4 h-14 w-14 flex justify-center items-center",children:(0,r.jsx)(d.G,{className:"text-white text-xl",icon:u?p.pL1:p.UOM})}),(0,r.jsx)("div",{className:"text-sm",children:"Practice"})]}),(0,r.jsxs)("div",{className:"flex flex-col items-center gap-2 flex-1 w-16",children:[(0,r.jsx)("button",{onClick:y?o:c,className:"shadow-custom-blue-shadow bg-white rounded-full p-4 h-14 w-14 flex justify-center items-center",children:(0,r.jsx)(d.G,{className:"text-[#0039FF] text-xl",icon:p.GJz})}),(0,r.jsx)("div",{className:"text-sm text-nowrap",children:"Your sound"})]})]})]})})}),(0,r.jsx)(g.y.Backdrop,{onTap:()=>{k(!1)}})]}),(0,r.jsx)("div",{className:"flex flex-col items-center w-full pb-6 px-7",children:(0,r.jsxs)("div",{className:"flex w-full justify-between items-center px-1",children:[(0,r.jsx)("button",{className:"text-black self-start flex items-center h-12 justify-center rounded-full",onClick:()=>{K(!1),D.sendAction({type:"STOP_CALL"}),et(),X.push("/")},children:(0,r.jsx)(d.G,{icon:p.g82,className:"text-xl"})}),(0,r.jsx)("div",{className:" mx-5 h-1.5 flex-grow bg-[#D9D9D9] rounded-full overflow-hidden",children:(0,r.jsx)("div",{className:"h-full bg-[#0039FF] rounded-full transition-all duration-300 ease-out",style:{width:"".concat(100*es,"%")}})}),(0,r.jsx)("button",{className:" text-black/30 self-start flex items-center h-12 justify-center rounded-full",onClick:()=>{},children:(0,r.jsx)(d.G,{icon:p.cRF,className:"text-xl"})})]})}),(0,r.jsxs)("div",{className:"flex-grow w-full overflow-auto px-7 pt-1",children:[er.length>0&&"Realtime"!==D.mode&&er.map((e,t)=>{let n=B&&"r".concat(t.toString())==H,s=en&&"l".concat(t.toString())==H,l=n||s;return(null==e?void 0:e.role)==="assistant"?(0,r.jsxs)("div",{className:"bg-white rounded-tl-none rounded-lg py-4 px-4 mb-8 ring-1 ring-black/10 mr-14",children:[(0,r.jsx)("img",{src:"mina.png",className:"w-7 h-7 mb-3 rounded-full"}),(0,r.jsx)("div",{className:"font-medium",children:N(l?Y(e.content):e.content)}),(0,r.jsx)("div",{className:"text-black/30",children:N(l?Y(M.translations[t],e.content):M.translations[t])}),(0,r.jsxs)("div",{className:"mt-2 flex gap-2",children:[l?(0,r.jsx)("div",{className:"material-symbols-rounded text-black/30 !text-xl",children:"stop_circle"}):(0,r.jsx)("div",{className:"material-symbols-rounded text-black/30 !text-xl",onClick:()=>{U(),L.sendAction({type:"SAY",text_stream:null==e?void 0:e.content,id:"r".concat(t)})},children:"volume_up"}),(0,r.jsx)("div",{className:"material-symbols-rounded text-black/30 !text-xl",onClick:()=>{M.sendAction({type:"REQUEST_TRANSLATION",index:t})},children:"translate"})]})]},t):(null==e?void 0:e.role)==="user"?(0,r.jsx)("div",{className:"flex justify-end",children:(0,r.jsx)("div",{className:"bg-[#0039FF]/5 ring-1 rounded-lg py-4 px-4 mb-8 ring-[#0039FF]/20 ml-14 rounded-tr-none",children:(0,r.jsx)("div",{className:"font-normal",children:null==e?void 0:e.content})})},t):void 0}),"Realtime"==D.mode&&(0,r.jsxs)("div",{className:"h-full flex flex-col justify-center items-center",children:[(0,r.jsxs)("div",{className:"bg-white flex flex-col items-center rounded-xl border-black/10 border-[1px] py-6 gap-2 mb-16 w-full",children:[(0,r.jsx)("img",{src:"mina.png",alt:"",className:"w-20 h-20"}),(0,r.jsx)("div",{className:"font-medium text-lg",children:"[lesson title]"}),(0,r.jsx)("div",{className:"bg-[#0039FF]/10 text-[#0039FF] p-2 rounded-md",children:"Real time call"})]}),(0,r.jsx)("div",{className:"text-black/30 text-center text-sm mx-8",children:"Caution: This mode is experimental and may not work as expected."})]}),(0,r.jsx)("div",{id:"CHAT_BOTTOM"})]}),(0,r.jsx)("div",{className:"w-full justify-end gap-5 tracking-[-0.02em] pointer-events-none",children:(0,r.jsxs)("div",{className:"flex flex-col w-full gap-4 pointer-events-auto  pb-10 pt-6   ".concat("Realtime"==D.mode?"":"border-black/10 border-t-2 bg-white"),children:[(0,r.jsx)(m.M,{mode:"wait",children:ea?(0,r.jsxs)(x.E.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.3},className:"flex flex-col items-center gap-5 h-[10.75rem] justify-center",children:[(0,r.jsx)(x.E.div,{initial:{y:-20},animate:{y:0},transition:{delay:.1,type:"spring",stiffness:300},className:"flex gap-2",children:[0,1,2].map(e=>(0,r.jsx)(x.E.div,{initial:{opacity:0,rotate:-180},animate:{opacity:1,rotate:0},transition:{delay:.1*e,duration:.3},children:(0,r.jsx)(d.G,{icon:p.Tab,className:"text-[#0039FF]"})},e))}),(0,r.jsx)(x.E.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4,duration:.3},children:"Amazing \uD83E\uDD73"})]},"encouragement"):er.length>0&&"Realtime"!==D.mode?(0,r.jsxs)(x.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[(0,r.jsx)("div",{className:"flex justify-center text-black/30 font-light mb-3 h-8",children:"Tap on the card for details \uD83D\uDC47"}),(0,r.jsx)("div",{className:"h-32",children:(0,r.jsx)(f.tq,{pagination:!0,modules:[h.tl],className:" bg-white w-screen",children:(null===(e=O.suggestions)||void 0===e?void 0:e.length)>=3?O.suggestions.map((e,t)=>(0,r.jsx)(f.o5,{className:"!h-auto px-6 py-2 mb-4",children:(0,r.jsxs)("button",{onClick:()=>{C(e),S(O.wordForWord[t]),F(O.translations[t]),k(!0)},className:"shadow-custom-shadow w-full h-full bg-white p-4 rounded-lg flex flex-col items-center",children:["Intermediate"==D.mode?(0,r.jsx)("div",{className:"flex gap-1 flex-wrap gap-y-5",children:O.wordForWord[t]&&O.wordForWord[t].length>0&&O.wordForWord[t].map((e,t)=>(0,r.jsx)("div",{className:"flex flex-col items-center",children:(0,r.jsx)("div",{className:"font-normal px-1 bg-black/5 rounded-sm mb-1 text-nowrap text-black/0",children:e.original})},t))}):(0,r.jsx)("div",{className:"overflow-hidden overflow-ellipsis whitespace-nowrap",children:N(e)}),(0,r.jsx)("div",{className:"text-black/30 overflow-hidden overflow-ellipsis whitespace-nowrap",children:N(O.translations[t])})]})},t)):(0,r.jsx)(r.Fragment,{children:Array.from({length:3}).map((e,t)=>(0,r.jsx)(f.o5,{className:"!h-auto px-6 py-2 mb-4",children:(0,r.jsx)("div",{className:"shadow-custom-shadow w-full h-full bg-white p-4 rounded-lg",children:(0,r.jsxs)("div",{className:"space-y-2 w-full flex flex-col items-center",children:[(0,r.jsx)("div",{className:"w-2/3 h-5 bg-gray-200 rounded animate-shimmer"}),(0,r.jsx)("div",{className:"w-2/3 h-5 bg-gray-200 rounded animate-shimmer"})]})})},t))})})})]},"messages"):null}),"CONNECTED"!==D.status?(0,r.jsx)("button",{className:" bg-[#0039FF] mx-8 text-white font-bold px-4 h-[3.6rem] flex-grow rounded-full flex items-center justify-center",onClick:()=>{z||(K(!0),D.sendAction({type:"START_CALL"}),U(),ee(),"Realtime"==D.mode&&Q(!0),q(!1))},children:(0,r.jsx)(d.G,{className:"animate-spin",icon:p.LM3})}):(0,r.jsx)("div",{className:"flex w-full justify-center items-center gap-6",children:"Realtime"==D.mode?(0,r.jsxs)("div",{className:"flex items-center justify-between w-full mx-8",children:[(0,r.jsx)("button",{className:"bg-black/5 h-14 w-14 rounded-full flex items-center justify-center",onClick:()=>{U(),J||Q(!0),q(!Z)},children:(0,r.jsx)(d.G,{icon:Z?p.EkX:p.UOM,className:"text-black text-xl "})}),(0,r.jsx)("button",{className:"bg-black/5 h-14 w-14 rounded-full flex items-center justify-center",onClick:()=>{K(!1),D.sendAction({type:"STOP_CALL"}),et(),X.push("/")},children:(0,r.jsx)(d.G,{icon:p.g82,className:"text-black text-xl "})})]}):(0,r.jsxs)(r.Fragment,{children:[J&&(0,r.jsx)("button",{ref:ei,className:"h-12 w-12 flex justify-center items-center text-xl rounded-full bg-red-200 text-red-600 ring-2 ring-red-600/50 transition-transform duration-200 ease-in-out hover:scale-110",children:(0,r.jsx)(d.G,{icon:p.g82})}),(0,r.jsx)(b,{onStartPress:()=>{Q(!0),q(!1)},onEndPress:()=>{Q(!1),U(),ec(!0),setTimeout(()=>{let e=new Audio("encouragement.mp3");e.volume=.5,e.play()},500),setTimeout(()=>{ec(!1)},1200)},onCancel:()=>{$()},cancelButtonRef:ei,children:e=>(0,r.jsx)("div",{className:"".concat(e?"bg-[#0039FF]/20 text-[#0039FF] ring-2 ring-[#0039FF]/40":"bg-[#0039FF] text-white","  px-14 py-6 text-3xl rounded-full"),children:(0,r.jsx)(d.G,{icon:e?p.FPD:p.UOM})})}),J&&(0,r.jsx)("div",{className:"w-12"})]})})]})})]})}function T(){return(0,r.jsx)(u,{children:(0,r.jsx)("main",{className:"bg-gradient-to-b from-[#F6F8FF] to-[#F7F8FD] h-screen pt-5",children:(0,r.jsx)(y,{})})})}},2374:function(e,t,n){"use strict";n.d(t,{GlobalAudioContextProvider:function(){return c},Z:function(){return i}});var r=n(7437),s=n(2265),l=n(4031);let a=(0,s.createContext)(void 0),c=e=>{let{children:t}=e,n=new(window.AudioContext||window.webkitAudioContext);return(0,r.jsx)(a.Provider,{value:{audioContext:n},children:t})};function i(e){let{onPlaybackChange:t,volume:n=1,speed:r=1}=e,c=(0,s.useContext)(l.Dm),i=(0,s.useContext)(a),o=(0,s.useRef)(null),u=(0,s.useRef)([]),d=(0,s.useRef)(0),m=(0,s.useRef)(null),x=(0,s.useRef)([]),f=(0,s.useRef)(null),h=(0,s.useRef)(null),[g,p]=(0,s.useState)(!1),[v,w]=(0,s.useState)(!1),[j,b]=(0,s.useState)(null),[N,y]=(0,s.useState)(null),T=(0,s.useRef)(null),k=()=>{if(x.current.forEach(e=>{clearTimeout(e)}),x.current=[],m.current&&(clearTimeout(m.current),m.current=null),0===u.current.length)return;let e=1,t=u.current.slice(0,1);for(let n of t)if(n&&n.buffer){let t=n.buffer.getChannelData(0);for(let n=0;n<t.length;n++)t[n]=t[n]*e,e-=1/(1*t.length)}u.current.slice(1).forEach(e=>{e.stop()}),u.current=t},E=()=>{p(!1),w(!1),x.current=[],T.current=null},C=async e=>{let{i:t,data:n,id:s,t:l}=e;if(null===o.current){console.error("AudioContext not initialized!");return}let a=new Int16Array(n),c=o.current.createBuffer(1,a.length,24e3),i=c.getChannelData(0);for(let e=0;e<a.length;e++)i[e]=a[e]/32768;let h=o.current.createBufferSource();h.connect(f.current),h.playbackRate.value=r,h.buffer=c;let g=0==t;g&&(u.current.length>0&&k(),d.current=o.current.currentTime);let v=d.current+.1*t/r+.1,j=o.current.currentTime-v;if(j>0&&(console.log("Audio chunk is late, delaying playback by ".concat(j," seconds.")),v+=j,d.current+=j),h.start(v),u.current.push(h),g&&(m.current=setTimeout(()=>{p(!0),y(0),void 0==s&&console.error("First chunk must have an id"),b(s),m.current=null},-(1e3*j))),h.onended=()=>{u.current.length>0&&(u.current.shift(),w(!1)),T.current&&t==T.current-1?E():0===u.current.length&&w(!0)},void 0!=l){let e=x.current.length,t=o.current.currentTime,n=l.map((n,s)=>setTimeout(()=>y(e+s),1e3*(d.current+n-t)/r));x.current.push(...n)}};return(0,s.useEffect)(()=>{if(!c){console.error("No session found!");return}return c.registerEvent("TTS_CHUNK",C),c.registerEvent("TTS_INTERRUPT",()=>{k()}),c.registerEvent("TTS_END",e=>{let{id:t,len:n}=e;j!==t||g?T.current=n:E()}),()=>{null==c||c.deregisterEvent("TTS_CHUNK"),null==c||c.deregisterEvent("TTS_INTERRUPT"),null==c||c.deregisterEvent("TTS_END")}},[c,r]),(0,s.useEffect)(()=>{null==t||t(g,j)},[g]),(0,s.useEffect)(()=>{f.current&&(f.current.gain.value=n)},[n]),(0,s.useEffect)(()=>{h.current&&(h.current.parameters.get("pitchFactor").value=1/r)},[r]),{isPlaying:g,isLagging:v,latestAudioId:j,latestCharIndex:N,startSpeaker:()=>{null===o.current&&((null==i?void 0:i.audioContext)?o.current=i.audioContext:o.current=new(window.AudioContext||window.webkitAudioContext),o.current.resume(),f.current=o.current.createGain(),console.log("Gain node created"),o.current.audioWorklet.addModule("worklets/phase-vocoder.js").then(()=>{h.current=new AudioWorkletNode(o.current,"phase-vocoder-processor"),f.current.connect(h.current),h.current.connect(o.current.destination),f.current.gain.value=n,h.current.parameters.get("pitchFactor").value=1/r,console.log("Phase vocoder worklet added")}).catch(e=>{console.error("Failed to add phase vocoder worklet",e)}))}}}}},function(e){e.O(0,[476,676,753,119,920,542,31,793,243,971,23,744],function(){return e(e.s=3658)}),_N_E=e.O()}]);