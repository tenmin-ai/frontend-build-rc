(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2293],{93658:function(e,t,n){Promise.resolve().then(n.bind(n,93706))},93706:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return H}});var s=n(57437),l=n(2265),i=n(74272),r=n(53974),a=n(14438),o=n(99376),c=n(89403);function d(e){let{children:t}=e,n=(0,r.useIsClient)(),{token:l}=(0,c.f)(),d=(0,o.useSearchParams)().get("session_id");return d?n?(0,s.jsx)(i.eA,{url:"".concat("wss://backend-us-rc.tenmin.ai","/ws/lesson/").concat(d,"?token=").concat(l),label:"Call",toast:a.A,autoconnect:!0,wsAuth:!0,binaryType:"arraybuffer",children:t}):null:(0,s.jsx)("div",{children:"Invalid lesson"})}var u=n(60755),x=n(5095),m=n(19764);n(7354),n(76889);var f=n(73377),h=n(49677),p=n(63399),g=n(15123),v=n(80434),j=n(61273),y=n(3069),b=n(22744),w=n(32859);let N=e=>{var t,n;let{isOpen:i,onClose:r,detailedTranslation:a,isTTSPlaying:o,onTTSPlay:c,isPracticeRecording:d,setPracticeRecording:u,isPracticePlaying:x,setPracticePlaying:m,onSave:f,isSaved:h}=e,p=null!==(t=null==a?void 0:a.wordForWord)&&void 0!==t?t:[],g=null!==(n=null==a?void 0:a.translation)&&void 0!==n?n:"",[v,N]=(0,l.useState)(null);return(0,s.jsxs)(y.y,{isOpen:i,onClose:()=>{r(),N(null)},detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsx)(y.y.Container,{children:(0,s.jsx)(y.y.Content,{style:{backgroundImage:"white"},children:(0,s.jsxs)("div",{className:"w-full p-8 pb-16 text-black",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Explanation"}),(0,s.jsxs)("div",{className:"flex gap-0",children:[void 0!==f&&(0,s.jsx)("button",{className:"p-2",onClick:()=>{f(null!=h&&h)},children:h?(0,s.jsx)(j.VF9,{}):(0,s.jsx)(j.mCg,{})}),(0,s.jsx)("button",{className:"p-2 text-lg",onClick:()=>{r(),N(null)},children:(0,s.jsx)(j._0w,{})})]})]}),(0,s.jsx)("div",{className:"mt-4 flex flex-wrap gap-1 gap-y-2",children:p.length>0&&p.map((e,t)=>(0,s.jsxs)("div",{className:"flex flex-col items-center rounded ".concat(v===t?"bg-[#0039FF]/10 text-[#0039FF]":"bg-black/5"),onClick:()=>{let n=e.original.trim();RegExp("^\\p{P}+$","u").test(n)||(c(n),N(t))},children:[(0,s.jsx)("div",{className:"text-nowrap px-1 text-xl font-normal",children:e.original}),(0,s.jsx)("div",{className:"text-nowrap px-1 text-sm opacity-50",children:e.translation})]},t))}),(0,s.jsxs)("div",{className:"mt-6 flex items-start gap-2 text-sm text-black/30",children:[(0,s.jsx)(b.mp2,{className:"flex-shrink-0 text-xl text-black/30"}),(0,s.jsx)("div",{children:g})]}),(0,s.jsxs)("div",{className:"mx-10 mt-10 flex justify-center gap-6",children:[(0,s.jsxs)("div",{className:"flex w-16 flex-1 flex-col items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>{c(),N(null)},className:"flex h-14 w-14 items-center justify-center rounded-full bg-white p-4 shadow-custom-blue-shadow",children:(0,s.jsx)(w.J,{className:"text-lg text-[#0039FF]",icon:o?j.JuG:j.gmG})}),(0,s.jsx)("div",{className:"text-sm",children:"Play"})]}),(0,s.jsxs)("div",{className:"flex w-16 flex-1 flex-col items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>u(!d),className:"flex h-14 w-14 items-center justify-center rounded-full bg-[#0039FF] p-4 shadow-custom-blue-shadow",children:(0,s.jsx)(w.J,{className:"text-xl text-white",icon:d?j.u9M:j.uYL})}),(0,s.jsx)("div",{className:"text-sm",children:"Practice"})]}),(0,s.jsxs)("div",{className:"flex w-16 flex-1 flex-col items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>m(!x),className:"flex h-14 w-14 items-center justify-center rounded-full bg-white p-4 shadow-custom-blue-shadow",children:(0,s.jsx)(j.tdo,{className:"text-xl text-[#0039FF]"})}),(0,s.jsx)("div",{className:"text-nowrap text-sm",children:"Your sound"})]})]})]})})}),(0,s.jsx)(y.y.Backdrop,{onTap:r})]})};var C=n(28529),k=n(49089),S=e=>{let{color:t="black"}=e;return(0,s.jsx)("svg",{width:"10",height:"16",viewBox:"0 0 10 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{d:"M0.0946622 2.84349C0.543847 1.57554 1.74925 0.722656 3.09681 0.722656H6.41168C8.39605 0.722656 9.99947 2.33176 9.99947 4.31045C9.99947 5.59546 9.31148 6.78381 8.19705 7.42631L6.36051 8.4782C6.34913 9.21737 5.74074 9.82007 4.99589 9.82007C4.23967 9.82007 3.63128 9.21168 3.63128 8.45546V7.68786C3.63128 7.19888 3.89283 6.74969 4.31927 6.5052L6.83812 5.06099C7.10536 4.90747 7.27025 4.62317 7.27025 4.31613C7.27025 3.83852 6.88361 3.45757 6.41168 3.45757H3.09681C2.90349 3.45757 2.73291 3.57697 2.67037 3.75892L2.64762 3.82715C2.39745 4.53788 1.61279 4.90747 0.907744 4.65729C0.202694 4.40711 -0.172574 3.62246 0.0776046 2.91741L0.100348 2.84918L0.0946622 2.84349ZM3.17641 13.459C3.17641 12.9765 3.36811 12.5137 3.70933 12.1725C4.05054 11.8312 4.51334 11.6396 4.99589 11.6396C5.47845 11.6396 5.94124 11.8312 6.28246 12.1725C6.62368 12.5137 6.81538 12.9765 6.81538 13.459C6.81538 13.9416 6.62368 14.4044 6.28246 14.7456C5.94124 15.0868 5.47845 15.2785 4.99589 15.2785C4.51334 15.2785 4.05054 15.0868 3.70933 14.7456C3.36811 14.4044 3.17641 13.9416 3.17641 13.459Z",fill:t})})};let T=e=>{let{isOpen:t,onClose:n,isVoiceDetected:i,selectedMic:r,acquireMic:a}=e,[o,c]=(0,l.useState)([]),d=async()=>{c((await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind))};return(0,l.useEffect)(()=>{d(),navigator.mediaDevices&&void 0!==navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=d)},[]),(0,l.useEffect)(()=>{let e=setInterval(()=>{d()},1e3);return()=>clearInterval(e)},[]),(0,s.jsxs)(y.y,{isOpen:t,onClose:n,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsx)(y.y.Container,{style:{backgroundColor:"#FAFBFF"},children:(0,s.jsx)(y.y.Content,{children:(0,s.jsxs)("div",{className:"w-full p-8 pb-16 text-black",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Settings"}),(0,s.jsx)("div",{className:"flex gap-3",children:(0,s.jsx)("button",{onClick:n,children:(0,s.jsx)(j._0w,{})})})]}),(0,s.jsxs)("div",{className:"mt-6 flex flex-col gap-5",children:[(0,s.jsx)("div",{className:"flex items-center gap-2 text-black",children:(0,s.jsx)("p",{children:"Your Microphone"})}),(0,s.jsx)("div",{className:"flex flex-col gap-2",children:o.map(e=>(0,s.jsx)("button",{className:"flex w-full items-center justify-between rounded-lg border px-3 py-3 font-normal ".concat(r==e.deviceId?"border-[#0039FF] bg-[#0039FF]/5 text-[#0039FF]":"bg-white"),onClick:()=>{a(e.deviceId)},children:(0,s.jsx)("p",{className:"text-sm",children:e.label||"Unknown Microphone"})},e.deviceId))}),(0,s.jsxs)("div",{className:"mb-12 flex items-center gap-2 text-sm text-black/30",children:[(0,s.jsx)("p",{children:"Try speaking to test your microphone:"}),(0,s.jsx)("div",{className:"flex h-1 w-8 items-center justify-center rounded-full ".concat(i?"bg-green-500":"bg-black/10")})]})]})]})})}),(0,s.jsx)(y.y.Backdrop,{onTap:n})]})};var A=n(68171);let E=e=>{let{isOpen:t,onClose:n}=e;return(0,s.jsxs)(y.y,{isOpen:t,onClose:n,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsx)(y.y.Container,{style:{backgroundColor:"#FAFBFF"},children:(0,s.jsx)(y.y.Content,{children:(0,s.jsxs)("div",{className:"w-full p-8 pb-16 text-black",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Tips and tricks"}),(0,s.jsx)("div",{className:"flex gap-3",children:(0,s.jsx)("button",{onClick:n,children:(0,s.jsx)(j._0w,{})})})]}),(0,s.jsx)("div",{className:"mt-6 flex flex-col gap-5",children:(0,s.jsxs)("div",{className:"text-black",children:[(0,s.jsx)("p",{children:"Did you know that you can use your native language to ask questions?"}),(0,s.jsx)("p",{className:"mt-2 italic text-[#0039FF]/50",children:'E.g. "How do I say that I am traveling to Portugal soon?"'})]})})]})})}),(0,s.jsx)(y.y.Backdrop,{onTap:n})]})},F=e=>{let{isOpen:t,onClose:n,inputBar:l}=e;return(0,s.jsxs)(y.y,{isOpen:t,onClose:n,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},disableDrag:!0,children:[(0,s.jsxs)(y.y.Container,{style:{backgroundColor:"#FAFBFF",borderTopLeftRadius:"16px",borderTopRightRadius:"16px"},children:[(0,s.jsx)(y.y.Header,{}),(0,s.jsx)(y.y.Content,{children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center pb-16 pt-4",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Speak again..."}),(0,s.jsx)("p",{className:"mb-6 mt-2 text-black/30",children:"Tap and hold the button"}),l]})})]}),(0,s.jsx)(y.y.Backdrop,{onTap:n})]})},_=e=>{let{isOpen:t,onClose:n,onQuit:l}=e;return(0,s.jsxs)(y.y,{isOpen:t,onClose:n,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsxs)(y.y.Container,{style:{backgroundColor:"#FAFBFF",borderTopLeftRadius:"16px",borderTopRightRadius:"16px"},children:[(0,s.jsx)(y.y.Header,{}),(0,s.jsx)(y.y.Content,{children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center px-7 pb-16 pt-4 text-center",children:[(0,s.jsx)("p",{className:"text-4xl font-semibold",children:"\uD83D\uDE2D"}),(0,s.jsx)("p",{className:"mt-4 text-lg font-medium",children:"Quit and you'll lose all XP gained in this lesson!"}),(0,s.jsx)("button",{className:"mt-8 flex w-full items-center justify-center rounded-full bg-[#2552F4] py-4 text-white",onClick:()=>{n()},children:(0,s.jsx)("p",{className:"text-base font-bold",children:"Keep learning"})}),(0,s.jsx)("button",{className:"mt-2 flex w-full items-center justify-center py-4 font-semibold text-red-600",onClick:()=>{l()},children:"Quit"})]})})]}),(0,s.jsx)(y.y.Backdrop,{onTap:n})]})};var R=n(16593),P=n(33344);let D=e=>{var t;let{isOpen:n,onClose:l,onFinish:i,streakPlus:a,xp:c,words:d,minutes:x}=e,m=(0,o.useRouter)(),[f,h]=(0,r.useLocalStorage)("language"),{data:p,isLoading:g}=(0,R.a)({...(0,P.rs)({query:{language:f}})}),v=Object.entries(p||{});v.length>0&&(null===(t=v[0][1])||void 0===t||t.streak);let b={hidden:{opacity:0,scale:.8},visible:{opacity:1,scale:1,transition:{duration:.5}}};return(0,s.jsxs)(y.y,{isOpen:n,onClose:l,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsxs)(y.y.Container,{style:{backgroundColor:"#FAFBFF",borderTopLeftRadius:"16px",borderTopRightRadius:"16px"},children:[(0,s.jsx)(y.y.Header,{}),(0,s.jsx)(y.y.Content,{children:(0,s.jsx)("main",{className:"flex flex-col bg-[#FAFBFF] pb-10 tracking-[-0.02em]",children:(0,s.jsxs)("div",{className:"flex h-full flex-col justify-between px-8",children:[(0,s.jsxs)("div",{className:"flex h-full flex-col items-center justify-center",children:[(0,s.jsxs)(u.E.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.3},className:"flex h-[10.75rem] flex-col items-center justify-center gap-5",children:[(0,s.jsx)(u.E.div,{initial:{y:-20},animate:{y:0},transition:{delay:.1,type:"spring",stiffness:300},className:"flex gap-2",children:[0,1,2].map(e=>(0,s.jsx)(u.E.div,{initial:{opacity:0,rotate:-180},animate:{opacity:1,rotate:0},transition:{delay:.1*e,duration:.3},children:(0,s.jsx)(j.QJe,{className:"text-4xl text-[#FFC800] ".concat(1==e&&"-translate-y-3")})},e))}),(0,s.jsx)(u.E.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4,duration:.3},className:"mt-2 text-center text-xl font-semibold",children:"Lesson complete!"})]},"encouragement"),(0,s.jsxs)("div",{className:"mt-0 grid w-full grid-cols-3 gap-2",children:[(0,s.jsxs)(u.E.div,{className:"flex flex-col items-center justify-center rounded-xl border-[1px] border-[#DADADA] bg-white py-4",variants:b,initial:"hidden",animate:"visible",children:[(0,s.jsx)(j.LkT,{className:"text-xl text-[#FFC800]"}),(0,s.jsx)("div",{className:"mt-2 text-lg font-medium",children:c}),(0,s.jsx)("div",{className:"text-xs text-black/30",children:"XP"})]}),(0,s.jsxs)(u.E.div,{className:"flex flex-col items-center justify-center rounded-xl border-[1px] border-[#DADADA] bg-white py-4",variants:b,initial:"hidden",animate:"visible",children:[(0,s.jsx)(j.ml,{className:"text-xl text-[#CD348E]"}),(0,s.jsx)("div",{className:"mt-2 text-lg font-medium",children:d}),(0,s.jsx)("div",{className:"text-xs text-black/30",children:"Words"})]}),(0,s.jsxs)(u.E.div,{className:"flex flex-col items-center justify-center rounded-xl border-[1px] border-[#DADADA] bg-white py-4",variants:b,initial:"hidden",animate:"visible",children:[(0,s.jsx)(j.qyc,{className:"text-xl text-[#34CD71]"}),(0,s.jsx)("div",{className:"mt-2 text-lg font-medium",children:x}),(0,s.jsx)("div",{className:"text-xs text-black/30",children:"Minutes"})]})]})]}),(0,s.jsx)("button",{className:"mt-8 flex w-full items-center justify-center rounded-full bg-[#2552F4] py-4 text-white",onClick:()=>{i(),a?m.push("/streakPlus"):m.push("/")},children:(0,s.jsx)("p",{className:"text-base font-semibold",children:"Finish lesson"})}),(0,s.jsx)("button",{className:"mt-2 flex w-full items-center justify-center py-4 font-semibold text-[#2552F4]",onClick:()=>{l()},children:"Continue conversation"})]})})})]}),(0,s.jsx)(y.y.Backdrop,{onTap:l})]})};var I=n(15731);let O=e=>{let{content:t,className:n,children:l}=e;return(0,s.jsx)("div",{className:"".concat("prose prose-code:whitespace-pre-wrap prose-code:before:hidden prose-code:after:hidden prose-pre:m-0 prose-pre:max-w-full prose-pre:bg-transparent prose-pre:p-0"," ").concat(n),children:(0,s.jsx)(I.AnimatedMarkdown,{content:("string"==typeof t?t:"string"==typeof l?l:"").replaceAll("\n","  \n"),sep:"word",animation:"fadeIn",animationDuration:"0.5s",animationTimingFunction:"ease-in-out"})})},L=e=>{let{parsed:t}=e;return(0,s.jsx)("pre",{className:"max-w-full whitespace-pre-wrap text-blue-500",children:JSON.stringify(t,null,1)})},M=e=>{let{parsed:t}=e;return(0,s.jsx)(O,{className:"text-lg",content:(null==t?void 0:t.text)||""})},B=e=>{let{parsed:t,onTTSPlay:n}=e,{entries:i}=t,[r,a]=(0,l.useState)(null);return(0,s.jsx)("div",{className:"flex flex-col flex-wrap gap-6",children:null==i?void 0:i.map((e,t)=>(0,s.jsxs)("div",{className:"flex flex-row items-center gap-2",children:[i.length>1&&(0,s.jsxs)("div",{className:"px-2 text-lg font-bold",children:[t+1,"."]}),(0,s.jsxs)("div",{onClick:()=>{var s;let l=(null==e?void 0:null===(s=e.word_or_expression)||void 0===s?void 0:s.trim())||"";RegExp("^\\p{P}+$","u").test(l)||(n(l),a(t))},className:"flex flex-col rounded p-2 ".concat(r===t?"bg-[#0039FF]/10 text-[#0039FF]":"bg-black/5"),children:[(0,s.jsx)(O,{className:"break-words text-xl font-normal ".concat(r===t?"text-[#0039FF]":""),children:e.word_or_expression}),(0,s.jsx)(O,{className:"whitespace-normal pt-2 text-sm opacity-50 ".concat(r===t?"text-[#0039FF]":""),children:e.translation})]})]},t))})},V=e=>{let{parsed:t,onTTSPlay:n}=e,[i,r]=(0,l.useState)(!1);return(0,s.jsxs)("div",{className:"flex flex-col items-center gap-3 text-center",children:[(0,s.jsx)("span",{className:"text-black/50",children:"Quiz:"}),(0,s.jsx)("div",{className:"rounded p-4 ".concat(i?"bg-[#0039FF]/10":"bg-black/5"),onClick:()=>{n(t.question||""),r(!0)},children:(0,s.jsx)(O,{content:t.question,className:"text-2xl ".concat(i?"text-[#0039FF]":"text-black")})})]})},W=e=>{let{parsed:t,onTTSPlay:n}=e;return(0,s.jsxs)("div",{className:"flex flex-col items-center",children:[(0,s.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,s.jsxs)("div",{className:"flex flex-row items-center gap-3 rounded border-red-500/50 bg-red-500/10 p-3",children:[(0,s.jsx)(w.J,{icon:j.zu6,className:"flex-none text-xl text-red-500"}),(0,s.jsx)(O,{className:"text-2xl text-red-500",children:null==t?void 0:t.student_said})]}),(0,s.jsxs)("div",{className:"flex flex-row items-center gap-3 rounded border border-green-500/50 bg-green-500/5 p-3",children:[(0,s.jsx)(w.J,{icon:j.ReY,className:"flex-none text-xl text-green-500"}),(0,s.jsx)("div",{className:"border-none",onClick:()=>n((null==t?void 0:t.should_be)||""),children:(0,s.jsx)(O,{className:"text-2xl text-green-500 underline",children:null==t?void 0:t.should_be})})]})]}),(0,s.jsx)("div",{className:"pt-16 text-center italic",children:(0,s.jsx)(O,{className:"text-black/50",content:null==t?void 0:t.brief_explanation})})]})},G=e=>{let{parsed:t,onTTSPlay:n}=e,[i,r]=(0,l.useState)(!1);return(0,s.jsx)("div",{className:"flex flex-col items-center gap-4",children:(0,s.jsx)("button",{className:"rounded px-4 py-2 ".concat(i?"bg-[#0039FF]/10":"bg-black/5"),onClick:()=>{r(!0),n((null==t?void 0:t.word_or_phrase)||"")},children:(0,s.jsx)(O,{className:"text-2xl ".concat(i?"text-[#0039FF]":"text-black"),children:null==t?void 0:t.word_or_phrase})})})};var U=e=>{let{funcCall:t,onTTSPlay:n}=e,l=t.name,i=JSON.parse(t.arguments||"{}");return i&&(0,s.jsx)("div",{children:"new_word_or_expressions"===l?(0,s.jsx)(B,{parsed:i,onTTSPlay:n}):"quiz_question"===l?(0,s.jsx)(V,{parsed:i,onTTSPlay:n}):"mistake_correction"===l?(0,s.jsx)(W,{parsed:i,onTTSPlay:n}):"pronunciation_practice"===l?(0,s.jsx)(G,{parsed:i,onTTSPlay:n}):"write_on_whiteboard"===l?(0,s.jsx)(M,{parsed:i}):(0,s.jsx)(L,{parsed:i})})};function Y(){var e,t,n,a,c,d,y,b,C,k,R,P,I,O;let L=(0,o.useSearchParams)().get("session_id"),M=(0,l.useRef)(null),B=(0,l.useRef)(null),{startRecording:V,stopRecording:W,playRecording:G,stopPlayback:Y,isPracticeRecording:H,isPlayingAudio:Q}=function(){let[e,t]=(0,l.useState)(!1),[n,s]=(0,l.useState)(!1),i=(0,l.useRef)(null),r=(0,l.useRef)(null),a=(0,l.useRef)(null),[o,c]=(0,l.useState)(null),d=async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0});i.current=e,r.current=new MediaRecorder(e);let n=[];r.current.ondataavailable=e=>{e.data.size>0&&n.push(e.data)},r.current.onstop=()=>{let e=new Blob(n,{type:"audio/mpeg"});c(e),t(!1)},r.current.start(),t(!0)}catch(e){console.error("Error accessing microphone:",e)}},u=()=>{r.current&&"recording"===r.current.state&&r.current.stop(),i.current&&i.current.getTracks().forEach(e=>e.stop())},x=()=>{a.current&&(a.current.pause(),a.current.currentTime=0,s(!1))};return(0,l.useEffect)(()=>()=>{u(),x()},[]),{startRecording:d,stopRecording:u,playRecording:()=>{o?(a.current||(a.current=new Audio),a.current.src=URL.createObjectURL(o),a.current.play(),s(!0),a.current.onended=()=>{s(!1)}):console.warn("No recording available to play")},stopPlayback:x,isPracticeRecording:e,isPlayingAudio:n}}(),[J,z]=(0,l.useState)(0),[K,Z]=(0,l.useState)(!1),[X,$]=(0,l.useState)(0),[ee,et]=(0,l.useState)(null),[en,es]=(0,l.useState)(""),[el,ei]=(0,l.useState)(null),er=(0,i.MV)("AUDIO_CALL",{status:"BACKEND_DISCONNECTED",mode:"Beginner",showStreakPlus:!1,xp:0,startTime:new Date().toISOString(),speedPreference:"NORMAL",lessonInfo:{},saved:[]}),ea=(0,i.MV)("STT",{requirePcm:void 0,totalTranscript:"",currTranscript:"",tempTranscript:""}),eo=(0,i.MV)("CHAT",{messages:[],userPreview:null,assistantPreview:null}),ec=(0,i.MV)("TTS",{volumeMultiplier:1}),[ed]=(0,l.useState)(1);(0,l.useEffect)(()=>((async()=>{try{await g.P.keepAwake()}catch(e){console.error("Failed to enable keep-awake",e)}})(),()=>{(async()=>{await g.P.allowSleep()})()}),[]);let{startSpeaker:eu,isPlaying:ex,latestAudioId:em,latestCharIndex:ef,setLatestAudioId:eh}=(0,p.Z)({onPlaybackStart:e=>{ec.sendAction({type:"PLAYBACK_STARTED",id:e})},onPlaybackFinish:e=>{ec.sendAction({type:"PLAYBACK_FINISHED",id:e})},onPlaybackInterrupt:(e,t,n)=>{ec.sendAction({type:"PLAYBACK_INTERRUPTED",id:e,played_duration:t,latest_char_index:n})},volume:ec.volumeMultiplier,speed:ed}),ep=(e,t)=>void 0==e||null==ef?"":t?t.length>0?e.slice(0,ef*e.length/t.length):e:e.slice(0,ef),[eg,ev]=(0,l.useState)(!1),ej=(0,o.useRouter)(),[ey,eb]=(0,l.useState)(!0),[ew,eN]=(0,l.useState)(!0),[eC,ek]=(0,l.useState)(!1),[eS,eT]=(0,l.useState)(null),[eA,eE]=(0,l.useState)(!1),[eF,e_]=(0,l.useState)(!1),[eR,eP]=(0,l.useState)(!1),{isVoiceDetected:eD,isRecording:eI,isMuted:eO,setMuted:eL,selectedMic:eM,startRecording:eB,stopRecording:eV,cancelRecording:eW,acquireMic:eG}=(0,h.Z)({onAudioData:e=>{if(!ea.requirePcm){if(0==e.byteLength){console.warn("Empty audio blob received");return}ea.sendBinary({type:"STREAM_MIC"},e)}},onPCMData(e){if(ea.requirePcm){if(0===e.byteLength){console.warn("Empty pcm data received");return}ea.sendBinary({type:"STREAM_PCM"},e)}},onRecordingStart:()=>{"Realtime"!=er.mode&&ea.sendAction({type:"PTT_PRESSED"})},onRecordingStop:e=>{"Realtime"!=er.mode&&(e?ea.sendAction({type:"PTT_CANCELLED"}):ea.sendAction({type:"PTT_RELEASED"}))},onSpeechStart:()=>{ea.sendAction({type:"VAD_CHANGED",detected:!0})},onSpeechEnd:()=>{ea.sendAction({type:"VAD_CHANGED",detected:!1})},startMuted:!1,recordingChunkSize:100}),eU=parseInt(null!==(O=null==em?void 0:em.slice(1))&&void 0!==O?O:"")>=eo.messages.length,eY=(0,l.useMemo)(()=>eo.messages.concat(eo.userPreview||[]).concat(eo.assistantPreview&&(eU||eo.assistantPreview.tool_calls)?eo.assistantPreview:[]),[eo.messages,eo.userPreview,eo.assistantPreview,eU]),eq=eY.reduce((e,t,n)=>"user"===t.role?n:e,-1),eH=eY.slice(0,eq),eQ=eY.slice(eq),eJ=eY.filter(e=>{var t;return"assistant"===e.role&&(null===(t=e.tool_calls)||void 0===t?void 0:t[0])}),ez=eJ[eJ.length-1],eK=(0,i.MV)("TRANSLATION",{wordForWord:{},translations:{}}),[eZ]=(0,i.tp)("CORRECTION",(e,t)=>{if("PERFECT"===t.type){if("Advanced"!==er.mode&&Z(!0),!ex&&!eI&&!H){let e=new Audio("encouragement.mp3");e.volume=.5,e.play()}setTimeout(()=>{Z(!1)},1200)}},{corrections:{}}),eX=(0,i.MV)("AUTOCOMPLETE",{suggestions:[],translations:[],wordForWord:[],saved:[]}),[e$,{height:e0}]=(0,r.useMeasure)();(0,l.useEffect)(()=>{z(eY.length/12),1==J&&"Smart"!==er.mode&&eP(!0)},[eY]),(0,l.useEffect)(()=>{"Smart"==er.mode&&eb(!1)},[er.mode]),(0,l.useEffect)(()=>{"CONNECTED"!=er.status&&"BACKEND_DISCONNECTED"!=er.status&&(eg||(console.log("Auto starting lesson"),ev(!0),eu(()=>{er.sendAction({type:"START_CALL"})},()=>{alert("Failed to start speaker")}),"Realtime"==er.mode&&eB(),eL(!1)))},[er.status]),(0,l.useEffect)(()=>{console.log("Scrolling to latest message");let e=document.getElementById("latest-user-message");e&&e.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},[eq]),(0,l.useEffect)(()=>{console.log("Scrolling to latest tool"),B.current&&B.current.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},[ez]);let[e1,e3]=(0,l.useState)(!1),e2={isPlaying:ex,latestAudioId:em,sliceTTS:ep,isPreviewTTSPlaying:eU,startSpeaker:eu,tts:ec,translation:eK,audioCall:er,correction:eZ,viewText:ew,setExplainedOriginal:es,setOpenedExplanation:$,setOpenedExplanationType:et,setOnExplanationSave:ei,setRedoMessageIndex:eT};return(0,s.jsxs)("div",{className:"flex h-full flex-col items-center tracking-[-0.02em]",children:[(0,s.jsx)(N,{isOpen:null!==ee,onClose:()=>{$(0),et(null),ei(null)},detailedTranslation:"message"===ee?{wordForWord:eK.wordForWord[X],translation:eK.translations[X]}:{wordForWord:eX.wordForWord[X],translation:eX.translations[X]},isTTSPlaying:ex&&"e"==em,onTTSPlay:e=>{eu(),en&&ec.sendAction({type:"SAY",text_stream:null!=e?e:en,id:"e"})},isPracticeRecording:H,setPracticeRecording:e=>{e?V():W()},isPracticePlaying:Q,setPracticePlaying:e=>{e?G():Y()},onSave:null!=el?el:void 0,isSaved:"message"===ee?er.saved[X]:"suggestion"===ee?eX.saved[X]:void 0}),(0,s.jsx)(T,{isOpen:e1,onClose:()=>{e3(!1)},isVoiceDetected:eD,selectedMic:eM,acquireMic:eG}),(0,s.jsx)(F,{isOpen:null!==eS,onClose:()=>{eT(null)},inputBar:(0,s.jsx)(A.y,{onStartPress:()=>{eB(),eL(!1)},onEndPress:()=>{if(null===eS){console.error("Redo message index is null");return}eo.sendAction({type:"RESET_TO_MESSAGE",index:eS}),eh("l".concat(eS-1)),eV(),eu(),setTimeout(()=>{eT(null)},100)},onCancel:()=>{eW()},leftToggle:(0,s.jsx)("div",{}),rightToggle:(0,s.jsx)("div",{})})}),(0,s.jsx)(E,{isOpen:eC,onClose:()=>ek(!1)}),(0,s.jsx)(D,{isOpen:eR,onClose:()=>eP(!1),onFinish:()=>{er.sendAction({type:"STOP_CALL"})},streakPlus:er.showStreakPlus,xp:er.xp,words:eY.filter(e=>"user"===e.role).reduce((e,t)=>"string"!=typeof t.content?e:e+t.content.split(" ").length,0),minutes:Math.ceil((new Date().getTime()-new Date(er.startTime).getTime())/1e3/60)}),(0,s.jsx)(_,{isOpen:eF,onClose:()=>e_(!1),onQuit:()=>{er.sendAction({type:"STOP_CALL"}),ej.back()}}),(0,s.jsx)("div",{className:"flex w-full flex-col items-center px-7 pb-2",children:(0,s.jsx)(u.E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.3},className:"w-full",children:(0,s.jsxs)("div",{className:"flex w-full items-center justify-between px-1",children:[(0,s.jsx)("button",{className:"flex h-12 items-center justify-center self-start rounded-full text-black",onClick:()=>{console.log("audioCall.showStreakPlus",er.showStreakPlus),ev(!1),J>=1?eP(!0):e_(!0)},children:(0,s.jsx)(j._0w,{className:"text-xl"})}),(0,s.jsx)("div",{className:"mx-5 h-1.5 w-full flex-grow overflow-hidden rounded-full bg-[#D9D9D9]",children:(0,s.jsx)("div",{className:"h-full rounded-full bg-[#2552F4] transition-all duration-300 ease-out",style:{width:"".concat(100*J,"%")}})}),(0,s.jsx)("button",{className:"flex h-12 items-center justify-center self-start rounded-full text-black/30",onClick:()=>{e3(!0)},children:(0,s.jsx)(j.F1m,{className:"text-xl"})})]})})}),eA&&(0,s.jsxs)("div",{className:"flex w-full flex-grow flex-col gap-16 overflow-auto overscroll-contain px-5 pb-6 pt-1",children:[eJ.length>1&&(0,s.jsx)("div",{className:"flex flex-col gap-5",children:(0,s.jsx)(q,{messages:eJ.slice(0,-1),onlyWhiteboard:!0,...e2})}),(0,s.jsxs)("div",{className:"flex h-full max-h-full w-full flex-none flex-col items-center justify-between gap-5 py-5",children:[(0,s.jsxs)("div",{className:"flex min-h-0 w-full grow flex-col items-center justify-around rounded-3xl border-[1px] border-black/10 bg-white px-4 py-5 transition-all duration-300 ease-in-out",children:[(0,s.jsx)("div",{className:"rounded-sm bg-[#2552F4]/10 px-2 py-1 font-medium text-[#2552F4]",onClick:()=>{var e;return null===(e=B.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},children:"Whiteboard"}),(0,s.jsx)("div",{className:"my-5 flex h-full w-full flex-col items-center justify-around overflow-y-scroll",children:ez&&(0,s.jsx)(U,{funcCall:ez.tool_calls[0].function,onTTSPlay:e=>{eu(),ec.sendAction({type:"SAY",text_stream:e,id:"w"})}})})]}),eY.length>0&&(0,s.jsxs)("div",{className:"flex w-full items-center justify-center gap-4 pb-1",onClick:()=>{let e=eY.findLastIndex(e=>"assistant"===e.role);if(-1!==e){let t=eY[e];if("string"!=typeof t.content)return;ex&&em==="r".concat(e)?ec.sendAction({type:"STOP",id:"r".concat(e)}):(eu(),ec.sendAction({type:"SAY",text_stream:t.content,id:"r".concat(e)}))}},children:["string"==typeof(null===(t=er.lessonInfo)||void 0===t?void 0:null===(e=t.tutor)||void 0===e?void 0:e.profile_picture_url)?(0,s.jsx)("img",{src:null===(a=er.lessonInfo)||void 0===a?void 0:null===(n=a.tutor)||void 0===n?void 0:n.profile_picture_url,className:"h-7 w-7 rounded-full transition-all duration-300 ease-in-out"}):null===(d=er.lessonInfo)||void 0===d?void 0:null===(c=d.tutor)||void 0===c?void 0:c.profile_picture_url,(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"max-h-[6em] min-w-0 flex-1 overflow-y-auto text-sm text-black/50",children:(()=>{let e=eY.findLastIndex(e=>"assistant"===e.role),t=eY[e];if("string"!=typeof(null==t?void 0:t.content))return"\uD83D\uDD0A";let n=null==t?void 0:t.content,s=ex&&"r".concat(e.toString())===em,l=eU&&"l".concat(e.toString())===em;return s||l?ep(n):n})()}),(0,s.jsx)("div",{className:"h-0 min-w-0 flex-1 text-sm text-black/50",style:{display:"-webkit-box",WebkitBoxOrient:"vertical",WebkitLineClamp:2,overflow:"hidden",textOverflow:"ellipsis",textAlign:"left"},children:(()=>{let e=eY.findLastIndex(e=>"assistant"===e.role),t=eY[e];return"string"!=typeof(null==t?void 0:t.content)?"\uD83D\uDD0A":null==t?void 0:t.content})()})]})]})]}),(0,s.jsx)("div",{className:"-mt-16",ref:B})]}),(0,s.jsxs)("div",{className:"w-full flex-grow overflow-y-scroll overscroll-contain px-7 pt-[1px] ".concat(eA?"hidden":""),style:{overflowAnchor:"none"},ref:e$,children:["Realtime"!==er.mode&&eH.length>0&&(0,s.jsx)(q,{messages:eH,...e2}),"Realtime"!==er.mode&&(0,s.jsx)("div",{style:{height:null!=e0?e0:"auto"},className:"pt-[1px]",id:"latest-user-message",children:(0,s.jsx)(q,{messages:eQ,indexOffset:eH.length,...e2})}),"Realtime"==er.mode&&(0,s.jsxs)("div",{className:"flex h-full flex-col items-center justify-center",children:[(0,s.jsxs)("div",{className:"mb-16 flex w-full flex-col items-center gap-2 rounded-xl border-[1px] border-black/10 bg-white py-6",children:[(0,s.jsx)("img",{src:null===(b=er.lessonInfo)||void 0===b?void 0:null===(y=b.tutor)||void 0===y?void 0:y.profile_picture_url,alt:"",className:"h-20 w-20"}),(0,s.jsx)("div",{className:"text-lg font-medium",children:null===(k=er.lessonInfo)||void 0===k?void 0:null===(C=k.lesson)||void 0===C?void 0:C.title}),(0,s.jsx)("div",{className:"text-3xl",children:null===(P=er.lessonInfo)||void 0===P?void 0:null===(R=P.lesson)||void 0===R?void 0:R.emoji}),(0,s.jsx)("div",{className:"rounded-md bg-[#0039FF]/10 p-2 text-[#0039FF]",children:"Real time call"})]}),(0,s.jsx)("div",{className:"mx-8 text-center text-sm text-black/30",children:"Caution: This mode is experimental and may not work as expected."})]}),(0,s.jsx)("div",{ref:M})]}),(0,s.jsx)("div",{className:"pointer-events-none w-full justify-end gap-5 tracking-[-0.02em]",children:(0,s.jsxs)("div",{className:"pointer-events-auto flex ".concat("Smart"==er.mode&&"h-36"," w-full flex-col items-center justify-center gap-4 pb-10 pt-4 ").concat("Realtime"==er.mode?"":"rounded-t-[2rem] border-[1px] border-black/10 bg-white"),children:[(0,s.jsx)(x.M,{mode:"wait",children:!K||"Smart"===er.mode||eI||eA?eY.length>0&&"Realtime"!==er.mode&&"Smart"!==er.mode&&"Advanced"!==er.mode?(0,s.jsxs)(u.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[(0,s.jsx)("div",{className:"mb-1 flex justify-center text-base font-light text-black/30",onClick:()=>{eb(!ey)},children:(0,s.jsx)(u.E.div,{animate:{rotateX:ey?0:180},transition:{duration:.6,ease:"easeInOut"},children:(0,s.jsx)(j.RiI,{className:"scale-y-75 transform"})})}),(0,s.jsx)(x.M,{children:ey&&(0,s.jsx)(u.E.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3,ease:"easeInOut",opacity:{duration:.05,ease:"easeInOut"},height:{duration:.3,ease:"easeInOut"}},className:"overflow-hidden",children:(0,s.jsx)("div",{className:"h-32",children:(0,s.jsx)(m.tq,{pagination:!0,modules:[f.tl],className:"w-screen bg-white",children:(null===(I=eX.suggestions)||void 0===I?void 0:I.length)>=3?eX.suggestions.map((e,t)=>(0,s.jsx)(m.o5,{className:"mb-4 !h-auto px-6 py-2",children:(0,s.jsxs)("button",{onClick:()=>{es(e),$(t),et("suggestion"),ei(()=>e=>{console.log("saving suggestion"),eX.sendAction({type:e?"DELETE_SUGGESTION":"SAVE_SUGGESTION",index:t})})},className:"flex h-full w-full flex-col items-center rounded-lg bg-white p-4 shadow-custom-shadow",children:["Intermediate"===er.mode||"Advanced"===er.mode?(0,s.jsx)("div",{className:"flex flex-wrap gap-1 gap-y-5",children:eX.wordForWord[t]&&eX.wordForWord[t].length>0&&eX.wordForWord[t].map((e,t)=>(0,s.jsx)("div",{className:"flex flex-col items-center",children:(0,s.jsx)("div",{className:"mb-1 text-nowrap rounded-sm bg-black/5 px-1 font-normal text-black/0",children:e.original})},t))}):(0,s.jsx)("div",{className:"w-full overflow-hidden overflow-ellipsis whitespace-nowrap",children:(0,v.f)(e)}),(0,s.jsx)("div",{className:"w-full overflow-hidden overflow-ellipsis whitespace-nowrap text-sm text-black/30",children:(0,v.f)(eX.translations[t])})]})},t)):(0,s.jsx)(s.Fragment,{children:Array.from({length:3}).map((e,t)=>(0,s.jsx)(m.o5,{className:"mb-4 !h-auto px-6 py-2",children:(0,s.jsx)("div",{className:"h-full w-full rounded-lg bg-white p-4 shadow-custom-shadow",children:(0,s.jsxs)("div",{className:"flex w-full flex-col items-center space-y-2",children:[(0,s.jsx)("div",{className:"animate-shimmer h-5 w-2/3 rounded bg-gray-200"}),(0,s.jsx)("div",{className:"animate-shimmer h-5 w-2/3 rounded bg-gray-200"})]})})},t))})})})})})]},"messages"):null:(0,s.jsxs)(u.E.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.3},className:"flex h-[10.75rem] flex-col items-center justify-center gap-5",children:[(0,s.jsx)(u.E.div,{initial:{y:-20},animate:{y:0},transition:{delay:.1,type:"spring",stiffness:300},className:"flex gap-2",children:[0,1,2].map(e=>(0,s.jsx)(u.E.div,{initial:{opacity:0,rotate:-180},animate:{opacity:1,rotate:0},transition:{delay:.1*e,duration:.3},children:(0,s.jsx)(j.QJe,{className:"text-[#0039FF]"})},e))}),(0,s.jsx)(u.E.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4,duration:.3},children:"Amazing \uD83E\uDD73"})]},"encouragement")}),"CONNECTED"!==er.status?(0,s.jsx)("button",{className:"flex hidden h-[3.6rem] flex-grow items-center justify-center rounded-full border-none px-4 font-bold text-[#2552F4]/80",onClick:()=>{eg||(ev(!0),eu(()=>{er.sendAction({type:"START_CALL"})},()=>{alert("Failed to start speaker")}),"Realtime"==er.mode&&eB(),eL(!1))},children:(0,s.jsx)(j.fCD,{className:"animate-spin"})}):"Realtime"==er.mode?(0,s.jsxs)("div",{className:"mx-8 flex w-full items-center justify-between",children:[(0,s.jsxs)("button",{className:"relative flex h-14 w-14 items-center justify-center rounded-full bg-black/5 ".concat(eD?"ring-4":""," ").concat(eO?"ring-red-500/70":"ring-green-500/70"),onClick:()=>{eu(),eI||eB(),eL(!eO)},children:[(0,s.jsx)(w.J,{icon:eO?j.uYL:j.RgM,className:"text-xl text-black"}),eD&&eO&&(0,s.jsx)("p",{className:"absolute -right-[120px] -top-8 rounded-full rounded-bl-none bg-black/5 p-2 text-sm",children:"Press to unmute"})]}),(0,s.jsx)("button",{className:"flex h-14 w-14 items-center justify-center rounded-full bg-black/5",onClick:()=>{ev(!1),er.sendAction({type:"STOP_CALL"}),console.log("audioCall.showStreakPlus",er.showStreakPlus),ej.push("/feedback?session_id=".concat(L))},children:(0,s.jsx)(j._0w,{className:"text-xl text-black"})})]}):"Smart"==er.mode?(0,s.jsx)(u.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:(0,s.jsx)(A.y,{onStartPress:()=>{eB(),eL(!1)},onEndPress:()=>{eV(),eu()},onCancel:()=>{eW()},leftToggle:(0,s.jsx)("div",{children:(0,s.jsx)("div",{className:"flex h-14 w-14 items-center justify-center rounded-full ".concat(ew?"bg-black/5":"bg-[#2552F4]/10 text-[#2552F4]"),onClick:()=>{let e=eY.filter(e=>"assistant"===e.role&&"string"==typeof e.content).slice(-1)[0];e&&(ex&&"rLatest"===em?ec.sendAction({type:"STOP",id:"rLatest"}):(eu(),ec.sendAction({type:"SAY",text_stream:e.content,id:"rLatest"})))},children:ex&&"rLatest"===em?(0,s.jsx)(j.u9M,{}):(0,s.jsx)(j.YRv,{})})}),rightToggle:(0,s.jsx)("div",{children:(0,s.jsx)("button",{className:"flex h-14 w-14 items-center justify-center rounded-full text-xl ".concat(eA?"bg-[#2552F4]/10 text-[#2552F4]":"bg-black/5"),onClick:()=>{eE(!eA),eA||(eb(!1),setTimeout(()=>{var e;null===(e=B.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"end",inline:"end"})},1)),eA&&setTimeout(()=>{var e;null===(e=M.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"end",inline:"end"})},1)},children:(0,s.jsx)(j.$e0,{})})})})}):(0,s.jsx)(A.y,{onStartPress:()=>{eB(),eL(!1)},onEndPress:()=>{eV(),eu()},onCancel:()=>{eW()},leftToggle:(0,s.jsx)("div",{children:void 0!==ew&&eN&&(0,s.jsx)("div",{className:"flex h-14 w-14 items-center justify-center rounded-full ".concat(ew?"bg-black/5":"bg-[#0039FF]/10 text-[#0039FF]"),onClick:()=>{eN(!ew)},children:(0,s.jsx)(j.Vbz,{})})}),rightToggle:(0,s.jsx)("div",{children:void 0!==eC&&ek&&(0,s.jsx)("button",{className:"flex h-14 w-14 items-center justify-center rounded-full bg-black/5",onClick:()=>{ek(!eC)},children:(0,s.jsx)(S,{})})})})]})})]})}let q=e=>{let{messages:t,indexOffset:n=0,onlyWhiteboard:l=!1,isPlaying:i,latestAudioId:r,isPreviewTTSPlaying:a,translation:o,audioCall:c,startSpeaker:d,tts:u,sliceTTS:x,correction:m,viewText:f,setExplainedOriginal:h,setOpenedExplanation:p,setOpenedExplanationType:g,setOnExplanationSave:v,setRedoMessageIndex:j}=e;return(0,s.jsx)(s.Fragment,{children:t.map((e,t)=>{var y,b,w,N;let S=t+n,T=i&&"r".concat(S.toString())===r,A=a&&"l".concat(S.toString())===r,E=T||A,F="Advanced"===c.mode||"Smart"===c.mode||!f||"string"!=typeof e.content;if((null==e?void 0:e.role)==="assistant")return(0,s.jsxs)("div",{children:[e.content&&!l&&(0,s.jsx)(C.nQ,{profilePicture:null===(b=c.lessonInfo)||void 0===b?void 0:null===(y=b.tutor)||void 0===y?void 0:y.profile_picture_url,isPlaying:E,message:"Advanced"!==c.mode&&f?"string"!=typeof e.content?"\uD83D\uDD0A":E?x(e.content):e.content:void 0,translation:F?void 0:E?x(o.translations[S],e.content):o.translations[S],onTap:()=>{A||"string"!=typeof e.content||(o.sendAction({type:"REQUEST_WORD_FOR_WORD",index:S}),h(e.content),p(S),g("message"),v(()=>e=>{c.sendAction({type:e?"DELETE_MESSAGE":"SAVE_MESSAGE",index:S})}))},onTTSPlay:()=>{d(),u.sendAction({type:"SAY",text_stream:null==e?void 0:e.content,id:"r".concat(S)})},onTTSStop:()=>{d(),u.sendAction({type:"STOP",id:"r".concat(S)})},onTranslate:F?void 0:e=>{e&&(o.translations[S]||o.sendAction({type:"REQUEST_TRANSLATION",index:S}))},defaultShowTranslation:"Beginner"===c.mode||"Smart"===c.mode}),e.tool_calls&&(null===(w=e.tool_calls[0])||void 0===w?void 0:w.function)&&(0,s.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1 text-sm text-[#2552F4]/80",children:[(0,s.jsx)("div",{className:"rounded-lg bg-[#2552F4]/10 p-1.5",children:(0,s.jsx)(k.jLr,{className:"text-sm text-[#2552F4]/80"})}),(0,s.jsx)("div",{className:"font-base text-sm font-extrabold",children:null!==(N=e.tool_calls[0].function.name.replaceAll("_"," ").toUpperCase())&&void 0!==N?N:"Whiteboard"})]}),(0,s.jsx)("div",{className:"mb-6 flex flex-col items-center justify-around rounded-3xl border border-black/10 bg-white p-10",children:(0,s.jsx)(U,{funcCall:e.tool_calls[0].function,onTTSPlay:e=>{d(),u.sendAction({type:"SAY",text_stream:e,id:"w"})}})})]})]},S);if((null==e?void 0:e.role)==="user"&&!l){let t=m.corrections[S];return(0,s.jsx)("div",{children:(0,s.jsx)(C.MI,{message:"string"==typeof e.content?e.content:"\uD83D\uDD0A",translation:o.translations[S],correction:t,onTap:()=>{A||"string"!=typeof e.content||(o.sendAction({type:"REQUEST_WORD_FOR_WORD",index:S}),h(e.content),p(S),g("message"),v(()=>()=>{c.sendAction({type:"SAVE_MESSAGE",index:S})}))},onTranslate:e=>{e&&(o.translations[S]||o.sendAction({type:"REQUEST_TRANSLATION",index:S}))},onRedo:()=>{j(S)},defaultShowTranslation:"Beginner"===c.mode||"Smart"===c.mode})},S)}return null})})};function H(){return(0,s.jsx)(d,{children:(0,s.jsx)("main",{className:"h-screen-safe bg-[#FAFBFF] pt-1",children:(0,s.jsx)(Y,{})})})}},56870:function(e,t,n){"use strict";n.d(t,{GlobalAudioContextProvider:function(){return r},Y:function(){return a}});var s=n(57437),l=n(2265);let i=(0,l.createContext)(null),r=e=>{let{children:t}=e,n=(0,l.useRef)(null);return n.current||(console.log("creating audio context"),n.current=new AudioContext,n.current.onstatechange=()=>{var e,t,s,l,i,r;if(console.log("onstagechange - AudioContext state changed: ",null===(e=n.current)||void 0===e?void 0:e.state),(null===(t=n.current)||void 0===t?void 0:t.state)==="suspended"&&(console.log("Attempting to resume AudioContext..."),null===(i=n.current)||void 0===i||i.resume().then(()=>{var e;console.log("AudioContext state: ",null===(e=n.current)||void 0===e?void 0:e.state)}).catch(e=>{console.error("Failed to resume AudioContext:",e)})),(null===(s=n.current)||void 0===s?void 0:s.state.toString())==="interrupted"&&console.log("Safari interrupted audiocontext, but won't resume for now..."),(null===(l=n.current)||void 0===l?void 0:l.state)==="running"){let e=null===(r=n.current)||void 0===r?void 0:r.currentTime;setTimeout(()=>{var t;(null===(t=n.current)||void 0===t?void 0:t.currentTime)===e&&(console.warn("AudioContext currentTime is stuck, attempting to fix..."),window.location.reload())},100)}}),(0,s.jsx)(i.Provider,{value:n.current,children:t})},a=()=>{let e=(0,l.useContext)(i);if(!e)throw Error("useAudioContext must be used within a GlobalAudioContextProvider");return e}},63399:function(e,t,n){"use strict";n.d(t,{Z:function(){return r}});var s=n(2265),l=n(74272),i=n(56870);function r(e){let{onPlaybackStart:t,onPlaybackFinish:n,onPlaybackInterrupt:r,volume:a=1,speed:o=1}=e,c=(0,s.useContext)(l.Dm),d=(0,i.Y)(),u=(0,s.useRef)([]),x=(0,s.useRef)(0),m=(0,s.useRef)(null),f=(0,s.useRef)([]),h=(0,s.useRef)(null),p=(0,s.useRef)(null),g=(0,s.useRef)(!1),[v,j]=(0,s.useState)(!1),y=(0,s.useRef)(v),[b,w]=(0,s.useState)(!1),[N,C]=(0,s.useState)(null),k=(0,s.useRef)(null),[S,T]=(0,s.useState)(null),A=(0,s.useRef)(null),E=()=>{F(),null!==p.current&&(p.current.disconnect(),p.current=null,console.log("Phase vocoder node disconnected and released")),null!==h.current&&(h.current.disconnect(),h.current=null,console.log("Gain node disconnected and released"))},F=()=>{if(f.current.forEach(e=>{clearTimeout(e)}),f.current=[],m.current&&(clearTimeout(m.current),m.current=null),0===u.current.length)return;let e=1,t=u.current.slice(0,5);for(let n of t)if(n&&n.buffer){let t=n.buffer.getChannelData(0);for(let n=0;n<t.length;n++)t[n]=t[n]*e,e-=1/(5*t.length)}u.current.slice(5).forEach(e=>{e.onended=null,e.stop()}),j(!1),y.current=!1;let n=d.currentTime-x.current;null==r||r(k.current,n,S),u.current=t},_=()=>{j(!1),y.current=!1,w(!1),f.current=[],A.current=null,null==n||n(k.current)},R=async e=>{let{i:n,data:s,id:l,t:i}=e,r=new Int16Array(s),a=d.createBuffer(1,r.length,24e3),c=a.getChannelData(0);for(let e=0;e<r.length;e++)c[e]=r[e]/32768;if(null===h.current){console.error("Gain node not created yet"),alert("Speaker not ready yet, this should not happen");return}let p=d.createBufferSource();p.connect(h.current),p.playbackRate.value=o,p.buffer=a;let g=0==n;g&&(u.current.length>0&&F(),x.current=d.currentTime,console.log("Audio start time reset to",x.current));let v=x.current+.1*n/o+.1,b=d.currentTime-v;if(b>0&&(console.log("Audio chunk is late, delaying playback by ".concat(b," seconds.")),v+=b,x.current+=b),p.start(v),u.current.push(p),g&&(m.current=setTimeout(()=>{j(!0),y.current=!0,null==t||t(l),T(0),void 0==l&&console.error("First chunk must have an id"),C(l),k.current=l,m.current=null},-(1e3*b))),p.onended=()=>{u.current.length>0&&(u.current.shift(),w(!1)),A.current&&n==A.current-1?(console.log("Natural end of audio"),_()):0===u.current.length&&(console.log("Lagging, no more audio to play"),w(!0))},void 0!=i){let e=f.current.length,t=d.currentTime,n=i.map((n,s)=>setTimeout(()=>T(e+s),1e3*(x.current+n-t)/o));f.current.push(...n)}};return(0,s.useEffect)(()=>{if(!c){console.log("No session found!");return}return c.registerEvent("TTS_CHUNK",R),c.registerEvent("TTS_INTERRUPT",()=>{F()}),c.registerEvent("TTS_END",e=>{let{id:t,len:n}=e;A.current=n}),()=>{null==c||c.deregisterEvent("TTS_CHUNK"),null==c||c.deregisterEvent("TTS_INTERRUPT"),null==c||c.deregisterEvent("TTS_END")}},[c,o]),(0,s.useEffect)(()=>{h.current&&(h.current.gain.value=a)},[a]),(0,s.useEffect)(()=>{p.current&&(p.current.parameters.get("pitchFactor").value=1/o)},[o]),(0,s.useEffect)(()=>()=>{E()},[]),{isPlaying:v,isLagging:b,latestAudioId:N,setLatestAudioId:C,latestCharIndex:S,startSpeaker:(e,t)=>{if(d.resume(),null===h.current){if(g.current){console.log("Speaker is already initializing");return}g.current=!0;try{h.current=d.createGain(),console.log("Gain node created"),h.current.connect(d.destination),h.current.gain.value=a,console.log("Gain node connected to destination"),null==e||e()}catch(e){console.error("Failed to create speaker",e)}finally{g.current=!1}null===h.current&&(null==t||t())}},stopSpeaker:E}}}},function(e){e.O(0,[4722,7240,1015,6051,7699,3260,8802,1811,2648,8351,4436,3069,813,3344,9939,2971,2117,1744],function(){return e(e.s=93658)}),_N_E=e.O()}]);